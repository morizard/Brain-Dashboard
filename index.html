<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…ØºØ² Ù…Ù†</title>
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700;900&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0d0d0f;
    --surface: #16161a;
    --surface2: #1e1e24;
    --border: #2a2a35;
    --accent: #c8a96e;
    --accent2: #7c6fcd;
    --text: #e8e8f0;
    --text-muted: #6b6b80;
    --green: #4caf7d;
    --red: #e05555;
    --blue: #5b9cf6;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Vazirmatn', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    direction: rtl;
  }

  /* HEADER */
  .header {
    padding: 24px 32px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 100;
    background: rgba(13,13,15,0.92);
    backdrop-filter: blur(12px);
  }

  .logo {
    font-size: 22px;
    font-weight: 900;
    letter-spacing: -0.5px;
    color: var(--accent);
  }

  .date-display {
    font-size: 13px;
    color: var(--text-muted);
    font-weight: 300;
  }

  /* TABS */
  .tabs {
    display: flex;
    gap: 4px;
    padding: 20px 32px 0;
    border-bottom: 1px solid var(--border);
    overflow-x: auto;
  }

  .tab {
    padding: 10px 20px;
    border-radius: 8px 8px 0 0;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-muted);
    border: none;
    background: transparent;
    font-family: 'Vazirmatn', sans-serif;
    transition: all 0.2s;
    white-space: nowrap;
  }

  .tab.active {
    background: var(--surface);
    color: var(--accent);
    border: 1px solid var(--border);
    border-bottom: 1px solid var(--surface);
    margin-bottom: -1px;
  }

  .tab:hover:not(.active) { color: var(--text); }

  /* MAIN LAYOUT */
  .main {
    padding: 28px 32px;
    max-width: 1200px;
    margin: 0 auto;
  }

  .page { display: none; }
  .page.active { display: block; }

  /* CARDS */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 16px;
  }

  .card-title {
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--text-muted);
    margin-bottom: 16px;
  }

  .grid-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }

  .grid-3 {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 16px;
  }

  /* JOURNAL */
  .journal-entry {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 12px;
    cursor: pointer;
    transition: border-color 0.2s;
  }

  .journal-entry:hover { border-color: var(--accent); }

  .journal-date {
    font-size: 11px;
    color: var(--text-muted);
    margin-bottom: 6px;
  }

  .journal-preview {
    font-size: 14px;
    line-height: 1.6;
    color: var(--text);
  }

  .journal-mood {
    display: inline-block;
    margin-top: 8px;
    font-size: 18px;
  }

  /* TODO */
  .todo-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 8px;
    background: var(--surface2);
    border: 1px solid transparent;
    transition: all 0.2s;
  }

  .todo-item:hover { border-color: var(--border); }
  .todo-item.done { opacity: 0.4; }
  .todo-item.done .todo-text { text-decoration: line-through; }

  .todo-check {
    width: 20px;
    height: 20px;
    border: 2px solid var(--border);
    border-radius: 50%;
    cursor: pointer;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    margin-top: 2px;
  }

  .todo-check.checked {
    background: var(--green);
    border-color: var(--green);
  }

  .todo-text {
    font-size: 14px;
    line-height: 1.5;
    flex: 1;
  }

  .priority-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
    margin-top: 6px;
  }

  .p-high { background: var(--red); }
  .p-mid { background: var(--accent); }
  .p-low { background: var(--green); }

  /* GOALS */
  .goal-card {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 16px;
  }

  .goal-title {
    font-size: 15px;
    font-weight: 600;
    margin-bottom: 6px;
  }

  .goal-deadline {
    font-size: 12px;
    color: var(--text-muted);
    margin-bottom: 12px;
  }

  .progress-bar {
    height: 6px;
    background: var(--border);
    border-radius: 99px;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    border-radius: 99px;
    background: linear-gradient(90deg, var(--accent2), var(--accent));
    transition: width 0.6s cubic-bezier(.4,0,.2,1);
  }

  .goal-percent {
    font-size: 11px;
    color: var(--text-muted);
    margin-top: 6px;
    text-align: left;
  }

  /* WISHES */
  .wish-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px;
    background: var(--surface2);
    border-radius: 8px;
    margin-bottom: 8px;
    border: 1px solid transparent;
    transition: all 0.2s;
  }

  .wish-item:hover { border-color: var(--accent); }

  .wish-emoji { font-size: 22px; }
  .wish-text { font-size: 14px; flex: 1; }
  .wish-cat {
    font-size: 11px;
    padding: 3px 8px;
    border-radius: 99px;
    background: var(--surface);
    color: var(--text-muted);
    border: 1px solid var(--border);
  }

  /* MEETINGS */
  .meeting-item {
    padding: 14px;
    background: var(--surface2);
    border-radius: 8px;
    margin-bottom: 8px;
    border-right: 3px solid var(--accent2);
  }

  .meeting-title { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
  .meeting-meta { font-size: 12px; color: var(--text-muted); }

  /* INPUT AREA */
  .input-row {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
  }

  input[type="text"], textarea, select {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 14px;
    color: var(--text);
    font-family: 'Vazirmatn', sans-serif;
    font-size: 14px;
    outline: none;
    transition: border-color 0.2s;
    direction: rtl;
  }

  input[type="text"]:focus, textarea:focus, select:focus {
    border-color: var(--accent);
  }

  input[type="text"] { flex: 1; }

  textarea {
    width: 100%;
    resize: vertical;
    min-height: 120px;
    line-height: 1.7;
  }

  select {
    background: var(--surface2);
    cursor: pointer;
  }

  .btn {
    padding: 10px 18px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-family: 'Vazirmatn', sans-serif;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.2s;
  }

  .btn-primary {
    background: var(--accent);
    color: #0d0d0f;
  }

  .btn-primary:hover { opacity: 0.85; transform: translateY(-1px); }

  .btn-ghost {
    background: transparent;
    color: var(--text-muted);
    border: 1px solid var(--border);
  }

  .btn-ghost:hover { color: var(--text); border-color: var(--text-muted); }

  /* MOOD BUTTONS */
  .mood-row {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
  }

  .mood-btn {
    font-size: 22px;
    background: var(--surface2);
    border: 2px solid transparent;
    border-radius: 8px;
    padding: 8px 12px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .mood-btn:hover, .mood-btn.selected { border-color: var(--accent); transform: scale(1.1); }

  /* STATS */
  .stat-box {
    text-align: center;
    padding: 20px;
    background: var(--surface2);
    border-radius: 10px;
  }

  .stat-num {
    font-size: 32px;
    font-weight: 900;
    color: var(--accent);
    line-height: 1;
    margin-bottom: 4px;
  }

  .stat-label { font-size: 12px; color: var(--text-muted); }

  /* MODAL */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 200;
    align-items: center;
    justify-content: center;
  }

  .modal-overlay.open { display: flex; }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 28px;
    width: 90%;
    max-width: 560px;
    max-height: 85vh;
    overflow-y: auto;
  }

  .modal-title {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 20px;
    color: var(--accent);
  }

  .form-label {
    font-size: 12px;
    color: var(--text-muted);
    margin-bottom: 6px;
    display: block;
    font-weight: 600;
  }

  .form-group { margin-bottom: 14px; }

  .delete-btn {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    font-size: 16px;
    padding: 4px;
    border-radius: 4px;
    transition: color 0.2s;
    flex-shrink: 0;
  }

  .delete-btn:hover { color: var(--red); }

  /* WEEK OVERVIEW */
  .week-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 8px;
    margin-bottom: 20px;
  }

  .week-day {
    text-align: center;
    padding: 10px 4px;
    border-radius: 8px;
    background: var(--surface2);
    border: 1px solid var(--border);
    cursor: pointer;
    transition: all 0.2s;
    font-size: 12px;
  }

  .week-day:hover, .week-day.today {
    border-color: var(--accent);
  }

  .week-day.today { background: rgba(200,169,110,0.1); }
  .week-day.selected-day { background: rgba(200,169,110,0.18); border-color: var(--accent); }

  .week-day-name { color: var(--text-muted); font-size: 10px; margin-bottom: 4px; }
  .week-day-num { font-weight: 700; font-size: 14px; }
  .week-dot { width: 5px; height: 5px; background: var(--accent); border-radius: 50%; margin: 4px auto 0; }

  .goal-filter-btn.active {
    background: var(--surface2);
    color: var(--accent);
    border-color: var(--accent);
  }

  .horizon-badge {
    display: inline-block;
    padding: 2px 10px;
    border-radius: 99px;
    font-size: 11px;
    font-weight: 600;
    border: 1px solid;
  }
  .h-short { color: #4caf7d; border-color: #4caf7d; background: rgba(76,175,125,0.1); }
  .h-mid   { color: #c8a96e; border-color: #c8a96e; background: rgba(200,169,110,0.1); }
  .h-long  { color: #7c6fcd; border-color: #7c6fcd; background: rgba(124,111,205,0.1); }

  .priority-flag {
    display: inline-block;
    padding: 2px 10px;
    border-radius: 99px;
    font-size: 11px;
    font-weight: 600;
    border: 1px solid;
  }
  .pf-1 { color: var(--red); border-color: var(--red); background: rgba(224,85,85,0.1); }
  .pf-2 { color: #e08c3a; border-color: #e08c3a; background: rgba(224,140,58,0.1); }
  .pf-3 { color: var(--text-muted); border-color: var(--border); background: transparent; }

  .summary-row {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 0;
    border-bottom: 1px solid var(--border);
  }
  .summary-row:last-child { border-bottom: none; }
  .summary-bar-wrap { flex: 1; }
  .summary-bar-bg { height: 5px; background: var(--border); border-radius: 99px; }
  .summary-bar-fill { height: 5px; border-radius: 99px; transition: width 0.5s; }
  .emoji-cat-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 4px 10px;
    font-size: 12px;
    color: var(--text-muted);
    cursor: pointer;
    font-family: 'Vazirmatn', sans-serif;
    transition: all 0.15s;
  }
  .emoji-cat-btn:hover { color: var(--text); border-color: var(--text-muted); }
  .emoji-cat-btn.active { background: var(--surface); color: var(--accent); border-color: var(--accent); }

  .emoji-btn {
    font-size: 20px;
    background: var(--surface2);
    border: 1px solid transparent;
    border-radius: 6px;
    padding: 6px;
    cursor: pointer;
    transition: all 0.15s;
    line-height: 1;
  }
  .emoji-btn:hover { border-color: var(--accent); transform: scale(1.15); background: rgba(200,169,110,0.1); }
  .emoji-btn.selected { border-color: var(--accent); background: rgba(200,169,110,0.15); }

  /* CALENDAR */
  .cal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
    padding: 0 4px;
  }
  .cal-nav-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--text);
    cursor: pointer;
    font-size: 18px;
    padding: 8px 16px;
    transition: all 0.2s;
    font-family: 'Vazirmatn', sans-serif;
    line-height: 1;
  }
  .cal-nav-btn:hover { border-color: var(--accent); color: var(--accent); transform: scale(1.05); }
  .cal-month-title {
    font-size: 22px;
    font-weight: 900;
    color: var(--text);
    letter-spacing: -0.5px;
    cursor: pointer;
    transition: color 0.2s;
  }
  .cal-month-title:hover { color: var(--accent); }
  .cal-month-title span { color: var(--accent); }
  .cal-today-btn {
    background: rgba(200,169,110,0.12);
    border: 1px solid rgba(200,169,110,0.4);
    border-radius: 8px;
    color: var(--accent);
    cursor: pointer;
    font-size: 12px;
    font-weight: 700;
    padding: 6px 14px;
    font-family: 'Vazirmatn', sans-serif;
    transition: all 0.2s;
  }
  .cal-today-btn:hover { background: rgba(200,169,110,0.22); }
  .cal-weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
    margin-bottom: 6px;
  }
  .cal-weekday-label {
    text-align: center;
    font-size: 11px;
    font-weight: 700;
    color: var(--text-muted);
    padding: 6px 2px;
    letter-spacing: 0.5px;
  }
  .cal-weekday-label.friday { color: #7c6fcd; }
  .cal-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
  }
  .cal-cell {
    min-height: 86px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 7px 6px 5px;
    cursor: pointer;
    transition: all 0.18s;
    position: relative;
    overflow: hidden;
  }
  .cal-cell:hover { border-color: var(--accent); background: rgba(200,169,110,0.06); z-index:1; }
  .cal-cell.today {
    border-color: var(--accent);
    background: rgba(200,169,110,0.1);
  }
  .cal-cell.selected {
    border-color: var(--accent);
    background: rgba(200,169,110,0.18);
    box-shadow: 0 0 0 2px rgba(200,169,110,0.25);
  }
  .cal-cell.other-month { opacity: 0.35; }
  .cal-cell.friday-cell { border-color: rgba(124,111,205,0.25); }
  .cal-cell.friday-cell:hover { border-color: #7c6fcd; }
  .cal-day-num {
    font-size: 13px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 4px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .cal-today-ring {
    width: 22px; height: 22px;
    background: var(--accent);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 12px; font-weight: 900; color: #0d0d0f;
    margin: -2px -2px 2px auto;
  }
  .cal-dot-row {
    display: flex;
    gap: 3px;
    flex-wrap: wrap;
    margin-top: 2px;
  }
  .cal-dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .cal-event-chip {
    font-size: 10px;
    padding: 2px 5px;
    border-radius: 4px;
    margin-top: 3px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
    display: block;
    font-weight: 600;
    line-height: 1.4;
  }
  .chip-todo   { background: rgba(224,85,85,0.18);   color: #e05555; }
  .chip-goal   { background: rgba(124,111,205,0.18); color: #7c6fcd; }
  .chip-meet   { background: rgba(91,156,246,0.18);  color: #5b9cf6; }
  .chip-journal{ background: rgba(76,175,125,0.18);  color: #4caf7d; }

  /* DAY DETAIL PANEL */
  .cal-detail {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 22px 24px;
    margin-top: 16px;
    animation: slideDown 0.2s ease;
  }
  @keyframes slideDown {
    from { opacity:0; transform:translateY(-8px); }
    to   { opacity:1; transform:translateY(0); }
  }
  .cal-detail-title {
    font-size: 17px;
    font-weight: 800;
    color: var(--accent);
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .cal-detail-section {
    margin-bottom: 14px;
  }
  .cal-detail-section-title {
    font-size: 11px;
    font-weight: 700;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1.2px;
    margin-bottom: 7px;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .cal-detail-item {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 9px 12px;
    margin-bottom: 6px;
    font-size: 13px;
    color: var(--text);
    display: flex;
    align-items: center;
    gap: 8px;
    line-height: 1.4;
  }
  .cal-detail-empty {
    color: var(--text-muted);
    font-size: 12px;
    padding: 4px 0;
    font-style: italic;
  }
  .cal-legend {
    display: flex;
    gap: 14px;
    flex-wrap: wrap;
    margin-top: 14px;
    padding-top: 14px;
    border-top: 1px solid var(--border);
  }
  .cal-legend-item {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 11px;
    color: var(--text-muted);
  }

  .idea-card {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px 16px;
    margin-bottom: 10px;
    transition: border-color 0.2s, transform 0.15s;
    position: relative;
  }
  .idea-card:hover { border-color: var(--accent); transform: translateY(-1px); }
  .idea-card.pinned { border-color: var(--accent); background: rgba(200,169,110,0.05); }
  .idea-status-badge {
    display: inline-block;
    padding: 2px 9px;
    border-radius: 99px;
    font-size: 11px;
    font-weight: 600;
    border: 1px solid;
  }
  .is-new    { color: #5b9cf6; border-color: #5b9cf6; background: rgba(91,156,246,0.1); }
  .is-wip    { color: #c8a96e; border-color: #c8a96e; background: rgba(200,169,110,0.1); }
  .is-done   { color: #4caf7d; border-color: #4caf7d; background: rgba(76,175,125,0.1); }
  .idea-tag {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 99px;
    font-size: 11px;
    border: 1px solid var(--border);
    color: var(--text-muted);
    margin-left: 4px;
    cursor: pointer;
    transition: all 0.15s;
  }
  .idea-tag:hover { border-color: var(--accent); color: var(--accent); }
  .idea-color-dot {
    width: 10px; height: 10px;
    border-radius: 50%;
    display: inline-block;
    margin-left: 6px;
    flex-shrink: 0;
  }
  .idea-search-bar {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 14px;
    color: var(--text);
    font-family: 'Vazirmatn', sans-serif;
    font-size: 14px;
    outline: none;
    width: 100%;
    transition: border-color 0.2s;
    direction: rtl;
  }
  .idea-search-bar:focus { border-color: var(--accent); }
  .idea-filter-btn {
    padding: 6px 14px;
    border-radius: 99px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text-muted);
    font-family: 'Vazirmatn', sans-serif;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }
  .idea-filter-btn:hover { color: var(--text); border-color: var(--text-muted); }
  .idea-filter-btn.active { background: rgba(200,169,110,0.15); color: var(--accent); border-color: var(--accent); }
  .idea-desc {
    font-size: 13px;
    color: var(--text-muted);
    line-height: 1.6;
    margin-top: 6px;
    white-space: pre-wrap;
  }

  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 99px; }

  @media (max-width: 640px) {
    .main { padding: 20px 16px; }
    .header { padding: 16px; }
    .tabs { padding: 16px 16px 0; }
    .grid-2, .grid-3 { grid-template-columns: 1fr; }
    .week-grid { grid-template-columns: repeat(7, 1fr); }
  }

  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-muted);
    font-size: 14px;
  }

  .empty-emoji { font-size: 32px; margin-bottom: 10px; }

  .tag {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 99px;
    font-size: 11px;
    border: 1px solid var(--border);
    color: var(--text-muted);
    margin-right: 4px;
  }

  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }

  .section-title {
    font-size: 18px;
    font-weight: 700;
  }
</style>
</head>
<body>

<div class="header">
  <div class="logo">ğŸ§  Ù…ØºØ²Ù…</div>
  <div style="display:flex;align-items:center;gap:12px">
    <div class="date-display" id="headerDate"></div>
    <div style="display:flex;align-items:center;gap:6px">
      <button id="sync-btn" onclick="syncToCloud()" style="
        background:var(--surface2);border:1px solid var(--border);border-radius:8px;
        padding:7px 12px;cursor:pointer;font-family:Vazirmatn,sans-serif;
        font-size:13px;color:var(--text);display:flex;align-items:center;gap:6px;
        transition:all 0.2s" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">
        <span id="sync-badge">âš™ï¸</span>
        <span>Ø³ÛŒÙ†Ú©</span>
      </button>
      <button onclick="syncFromCloud()" style="
        background:none;border:1px solid var(--border);border-radius:8px;
        padding:7px 10px;cursor:pointer;font-size:13px;color:var(--text-muted);
        transition:all 0.2s" title="Ø¯Ø±ÛŒØ§ÙØª Ø§Ø² cloud" onmouseover="this.style.borderColor='var(--accent2)'" onmouseout="this.style.borderColor='var(--border)'">â¬‡ï¸</button>
      <button onclick="openSBSettings()" style="
        background:none;border:1px solid var(--border);border-radius:8px;
        padding:7px 10px;cursor:pointer;font-size:13px;color:var(--text-muted);
        transition:all 0.2s" title="ØªÙ†Ø¸ÛŒÙ…Ø§Øª cloud" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">âš™ï¸</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div id="toast" style="
  position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(20px);
  background:var(--surface);border:1px solid var(--border);border-radius:10px;
  padding:10px 20px;font-size:14px;font-family:Vazirmatn,sans-serif;
  color:var(--text);z-index:500;opacity:0;transition:all 0.3s;pointer-events:none;
  box-shadow:0 4px 20px rgba(0,0,0,0.4)
"></div>

<div class="tabs">
  <button class="tab active" onclick="switchTab('dashboard')">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</button>
  <button class="tab" onclick="switchTab('calendar')">ğŸ“… ØªÙ‚ÙˆÛŒÙ…</button>
  <button class="tab" onclick="switchTab('journal')">Ú˜ÙˆØ±Ù†Ø§Ù„</button>
  <button class="tab" onclick="switchTab('todos')">Ú©Ø§Ø±Ù‡Ø§</button>
  <button class="tab" onclick="switchTab('goals')">Ø§Ù‡Ø¯Ø§Ù</button>
  <button class="tab" onclick="switchTab('wishes')">Ø¢Ø±Ø²ÙˆÙ‡Ø§</button>
  <button class="tab" onclick="switchTab('meetings')">Ø¬Ù„Ø³Ø§Øª</button>
  <button class="tab" onclick="switchTab('ideas')">ğŸ’¡ Ø§ÛŒØ¯Ù‡â€ŒÙ‡Ø§</button>
</div>

<div class="main">

  <!-- DASHBOARD -->
  <div class="page active" id="page-dashboard">
    <div class="grid-3" style="margin-bottom:20px">
      <div class="stat-box">
        <div class="stat-num" id="stat-todos">0</div>
        <div class="stat-label">Ú©Ø§Ø± Ø¯Ø± ØµÙ</div>
      </div>
      <div class="stat-box">
        <div class="stat-num" id="stat-goals">0</div>
        <div class="stat-label">Ù‡Ø¯Ù ÙØ¹Ø§Ù„</div>
      </div>
      <div class="stat-box">
        <div class="stat-num" id="stat-journal" style="font-size:28px;line-height:1.2">â€”</div>
        <div class="stat-label" id="stat-journal-label">Ø­Ø§Ù„ Ù‡ÙØªÙ‡</div>
      </div>
    </div>

    <!-- Week view -->
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
        <div class="card-title" style="margin:0">Ù‡ÙØªÙ‡ Ø¬Ø§Ø±ÛŒ</div>
        <div style="display:flex;align-items:center;gap:10px">
          <button onclick="navigateWeek(-1)" style="background:none;border:1px solid var(--border);border-radius:8px;color:var(--text-muted);cursor:pointer;padding:4px 10px;font-size:13px;font-family:Vazirmatn,sans-serif;transition:all 0.2s" onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--accent)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text-muted)'">â€¹ Ù‚Ø¨Ù„</button>
          <div id="week-month-label" style="font-size:13px;color:var(--accent);font-weight:600;min-width:100px;text-align:center"></div>
          <button onclick="navigateWeek(1)" style="background:none;border:1px solid var(--border);border-radius:8px;color:var(--text-muted);cursor:pointer;padding:4px 10px;font-size:13px;font-family:Vazirmatn,sans-serif;transition:all 0.2s" onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--accent)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text-muted)'">Ø¨Ø¹Ø¯ â€º</button>
        </div>
      </div>
      <div class="week-grid" id="weekGrid"></div>
    </div>

    <!-- Selected day todos -->
    <div class="card">
      <div class="section-header">
        <div class="card-title" style="margin:0" id="dashboard-todos-title">Ú©Ø§Ø±Ù‡Ø§ÛŒ Ù…Ù‡Ù… Ø§Ù…Ø±ÙˆØ²</div>
        <button class="btn btn-ghost" style="font-size:12px;padding:6px 12px" onclick="switchTab('todos')">Ù‡Ù…Ù‡ â†</button>
      </div>
      <div id="dashboard-todos"></div>
    </div>

    <!-- Upcoming meetings -->
    <div class="card">
      <div class="section-header">
        <div class="card-title" style="margin:0">Ø¬Ù„Ø³Ø§Øª Ù¾ÛŒØ´â€ŒØ±Ùˆ</div>
        <button class="btn btn-ghost" style="font-size:12px;padding:6px 12px" onclick="switchTab('meetings')">Ù‡Ù…Ù‡ â†</button>
      </div>
      <div id="dashboard-meetings"></div>
    </div>
  </div>

  <!-- CALENDAR -->
  <div class="page" id="page-calendar">

    <div class="card" style="padding:24px">
      <!-- Header -->
      <div class="cal-header">
        <button class="cal-nav-btn" onclick="calNav(-1)">â€¹</button>
        <div style="text-align:center">
          <div class="cal-month-title" id="cal-month-title" onclick="openCalMonthPicker()" title="Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ± Ú©Ù„ÛŒÚ© Ú©Ù†">â€”</div>
          <div style="font-size:11px;color:var(--text-muted);margin-top:2px" id="cal-year-sub"></div>
        </div>
        <button class="cal-nav-btn" onclick="calNav(1)">â€º</button>
      </div>

      <div style="display:flex;justify-content:center;margin-bottom:18px">
        <button class="cal-today-btn" onclick="calGoToday()">â— Ø¨Ø±Ùˆ Ø¨Ù‡ Ø§Ù…Ø±ÙˆØ²</button>
      </div>

      <!-- Weekday labels -->
      <div class="cal-weekdays">
        <div class="cal-weekday-label">Ø´</div>
        <div class="cal-weekday-label">ÛŒ</div>
        <div class="cal-weekday-label">Ø¯</div>
        <div class="cal-weekday-label">Ø³</div>
        <div class="cal-weekday-label">Ú†</div>
        <div class="cal-weekday-label">Ù¾</div>
        <div class="cal-weekday-label friday">Ø¬</div>
      </div>

      <!-- Grid -->
      <div class="cal-grid" id="cal-grid"></div>

      <!-- Legend -->
      <div class="cal-legend">
        <div class="cal-legend-item"><div class="cal-dot" style="background:#e05555"></div> Ú©Ø§Ø± ÙÙˆØ±ÛŒ</div>
        <div class="cal-legend-item"><div class="cal-dot" style="background:#7c6fcd"></div> Ù‡Ø¯Ù</div>
        <div class="cal-legend-item"><div class="cal-dot" style="background:#5b9cf6"></div> Ø¬Ù„Ø³Ù‡</div>
        <div class="cal-legend-item"><div class="cal-dot" style="background:#4caf7d"></div> Ú˜ÙˆØ±Ù†Ø§Ù„</div>
      </div>
    </div>

    <!-- Day detail -->
    <div id="cal-detail-panel"></div>

  </div>

  <!-- JOURNAL -->
  <div class="page" id="page-journal">

    <!-- JOURNAL SUMMARY -->
    <div class="card" id="journal-summary-card">
      <div id="journal-summary-content"></div>
    </div>

    <div class="card">
      <div class="section-header">
        <div class="section-title">ğŸ“” Ú˜ÙˆØ±Ù†Ø§Ù„ Ø§Ù…Ø±ÙˆØ²</div>
        <div id="journal-today-date" style="font-size:13px;color:var(--text-muted)"></div>
      </div>

      <div class="form-group">
        <label class="form-label">Ø§Ù„Ø§Ù† Ú†Ù‡ Ø³Ø§Ø¹ØªÛŒÙ‡ØŸ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
        <div style="display:flex;gap:8px;align-items:center">
          <input type="text" id="journal-time" placeholder="Ø³Ø§Ø¹Øª ÙØ¹Ù„ÛŒ" readonly style="max-width:120px;cursor:pointer" onclick="openTimePicker('journal-time')">
          <button type="button" class="btn btn-ghost" onclick="openTimePicker('journal-time')" style="padding:10px 12px">ğŸ•</button>
          <button type="button" class="btn btn-ghost" onclick="setJournalTimeNow()" style="padding:10px 12px;font-size:12px">Ø§Ù„Ø§Ù†</button>
          <button type="button" class="btn btn-ghost" onclick="document.getElementById('journal-time').value=''" style="padding:10px 12px;color:var(--text-muted);font-size:12px">âœ•</button>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Ø­Ø§Ù„Øª Ø§Ù„Ø§Ù†Øª Ú†Ø·ÙˆØ±Ù‡ØŸ</label>
        <div class="mood-row">
          <button class="mood-btn" onclick="selectMood(this,'ğŸ˜')">ğŸ˜</button>
          <button class="mood-btn" onclick="selectMood(this,'ğŸ™‚')">ğŸ™‚</button>
          <button class="mood-btn" onclick="selectMood(this,'ğŸ˜')">ğŸ˜</button>
          <button class="mood-btn" onclick="selectMood(this,'ğŸ˜”')">ğŸ˜”</button>
          <button class="mood-btn" onclick="selectMood(this,'ğŸ˜¤')">ğŸ˜¤</button>
          <button class="mood-btn" onclick="selectMood(this,'ğŸ˜°')">ğŸ˜°</button>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Ú†ÛŒ ØªÙˆÛŒ Ø°Ù‡Ù†ØªÙ‡ØŸ</label>
        <textarea id="journal-text" placeholder="Ø¨Ù†ÙˆÛŒØ³... Ù‡Ø± Ú†ÛŒØ²ÛŒ Ú©Ù‡ Ù…ÛŒØ®ÙˆØ§ÛŒ. Ø§ÛŒÙ†Ø¬Ø§ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ ØªÙˆØ¦Ù‡."></textarea>
      </div>

      <button class="btn btn-primary" onclick="saveJournal()">Ø°Ø®ÛŒØ±Ù‡ â†</button>
    </div>

    <div class="card">
      <div class="card-title">ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ</div>
      <div id="journal-list"></div>
    </div>
  </div>

  <!-- TODOS -->
  <div class="page" id="page-todos">
    <div class="card" id="todos-summary">
      <div id="todos-summary-content"></div>
    </div>

    <div class="card">
      <div class="input-row">
        <input type="text" id="todo-input" placeholder="Ú©Ø§Ø± Ø¬Ø¯ÛŒØ¯ Ø¨Ù†ÙˆÛŒØ³..." onkeydown="if(event.key==='Enter')addTodo()">
        <select id="todo-priority">
          <option value="high">ğŸ”´ ÙÙˆØ±ÛŒ</option>
          <option value="mid" selected>ğŸŸ¡ Ù…Ø¹Ù…ÙˆÙ„ÛŒ</option>
          <option value="low">ğŸŸ¢ Ø²Ù…Ø§Ù†ÛŒ</option>
        </select>
        <button class="btn btn-primary" onclick="addTodo()">+</button>
      </div>
      <div class="input-row">
        <input type="text" id="todo-tag" placeholder="Ø¨Ø±Ú†Ø³Ø¨ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)" style="max-width:150px">
        <input type="text" id="todo-date" placeholder="Ø³Ø±Ø±Ø³ÛŒØ¯ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)" readonly style="max-width:170px;cursor:pointer" onclick="openPicker('todo-date')">
        <button class="btn btn-ghost" onclick="openPicker('todo-date')" style="padding:10px 12px">ğŸ“…</button>
        <input type="text" id="todo-time" placeholder="Ø³Ø§Ø¹Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)" readonly style="max-width:130px;cursor:pointer" onclick="openTimePicker('todo-time')">
        <button class="btn btn-ghost" onclick="openTimePicker('todo-time')" style="padding:10px 12px">ğŸ•</button>
      </div>
    </div>

    <div class="card">
      <div class="section-header">
        <div class="section-title">ğŸ”´ ÙÙˆØ±ÛŒ</div>
      </div>
      <div id="todos-high"></div>
    </div>

    <div class="card">
      <div class="section-header">
        <div class="section-title">ğŸŸ¡ Ù…Ø¹Ù…ÙˆÙ„ÛŒ</div>
      </div>
      <div id="todos-mid"></div>
    </div>

    <div class="card">
      <div class="section-header">
        <div class="section-title">ğŸŸ¢ Ø²Ù…Ø§Ù†ÛŒ</div>
      </div>
      <div id="todos-low"></div>
    </div>

    <div class="card">
      <div class="section-header">
        <div class="section-title" style="color:var(--text-muted)">âœ… Ø§Ù†Ø¬Ø§Ù…â€ŒØ´Ø¯Ù‡</div>
        <button class="btn btn-ghost" style="font-size:12px;padding:6px 12px;color:var(--red)" onclick="clearDone()">Ù¾Ø§Ú©â€ŒÚ©Ø±Ø¯Ù†</button>
      </div>
      <div id="todos-done"></div>
    </div>
  </div>

  <!-- GOALS -->
  <div class="page" id="page-goals">
    <div class="card" id="goals-summary" style="display:none">
      <div class="card-title">Ø®Ù„Ø§ØµÙ‡ Ù¾ÛŒØ´Ø±ÙØª</div>
      <div id="goals-summary-content"></div>
    </div>
    <div class="card" style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn btn-primary" onclick="openModal('goal')">+ Ù‡Ø¯Ù Ø¬Ø¯ÛŒØ¯</button>
      <button class="btn btn-ghost goal-filter-btn active" onclick="filterGoals('all',this)">Ù‡Ù…Ù‡</button>
      <button class="btn btn-ghost goal-filter-btn" onclick="filterGoals('short',this)">Ú©ÙˆØªØ§Ù‡â€ŒÙ…Ø¯Øª</button>
      <button class="btn btn-ghost goal-filter-btn" onclick="filterGoals('mid',this)">Ù…ÛŒØ§Ù†â€ŒÙ…Ø¯Øª</button>
      <button class="btn btn-ghost goal-filter-btn" onclick="filterGoals('long',this)">Ø¨Ù„Ù†Ø¯Ù…Ø¯Øª</button>
    </div>
    <div id="goals-list"></div>
  </div>

  <!-- WISHES -->
  <div class="page" id="page-wishes">
    <div class="card">
      <div class="input-row" style="margin-bottom:10px">
        <button type="button" id="wish-emoji-btn" onclick="toggleEmojiPicker()" style="
          font-size:22px;background:var(--surface2);border:1px solid var(--border);
          border-radius:8px;padding:8px 14px;cursor:pointer;transition:border-color 0.2s;min-width:54px
        " title="Ø§Ù†ØªØ®Ø§Ø¨ Ø¢ÛŒÚ©ÙˆÙ†">â­</button>
        <input type="text" id="wish-input" placeholder="Ø¢Ø±Ø²ÙˆÛŒ Ø¬Ø¯ÛŒØ¯..." onkeydown="if(event.key==='Enter')addWish()">
        <select id="wish-cat">
          <option value="Ø²Ù†Ø¯Ú¯ÛŒ">Ø²Ù†Ø¯Ú¯ÛŒ</option>
          <option value="Ú©Ø§Ø±">Ú©Ø§Ø±</option>
          <option value="Ø³ÙØ±">Ø³ÙØ±</option>
          <option value="Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡">Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡</option>
          <option value="Ù…Ø§Ù„ÛŒ">Ù…Ø§Ù„ÛŒ</option>
          <option value="Ø³Ù„Ø§Ù…Øª">Ø³Ù„Ø§Ù…Øª</option>
          <option value="Ø¯ÛŒÚ¯Ø±">Ø¯ÛŒÚ¯Ø±</option>
        </select>
        <button class="btn btn-primary" onclick="addWish()">+</button>
      </div>

      <!-- EMOJI PICKER -->
      <div id="emoji-picker" style="display:none">
        <div style="display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap">
          <button class="emoji-cat-btn active" onclick="showEmojiCat('all',this)">Ù‡Ù…Ù‡</button>
          <button class="emoji-cat-btn" onclick="showEmojiCat('nature',this)">Ø·Ø¨ÛŒØ¹Øª</button>
          <button class="emoji-cat-btn" onclick="showEmojiCat('travel',this)">Ø³ÙØ±</button>
          <button class="emoji-cat-btn" onclick="showEmojiCat('activity',this)">ÙØ¹Ø§Ù„ÛŒØª</button>
          <button class="emoji-cat-btn" onclick="showEmojiCat('food',this)">ØºØ°Ø§</button>
          <button class="emoji-cat-btn" onclick="showEmojiCat('work',this)">Ú©Ø§Ø±</button>
          <button class="emoji-cat-btn" onclick="showEmojiCat('people',this)">Ø§Ø­Ø³Ø§Ø³Ø§Øª</button>
          <button class="emoji-cat-btn" onclick="showEmojiCat('objects',this)">Ø§Ø´ÛŒØ§Ø¡</button>
          <button class="emoji-cat-btn" onclick="showEmojiCat('symbols',this)">Ù†Ù…Ø§Ø¯Ù‡Ø§</button>
        </div>
        <input type="text" id="emoji-search" placeholder="ğŸ” Ø¬Ø³ØªØ¬Ùˆ..." oninput="searchEmoji(this.value)"
          style="width:100%;margin-bottom:10px;font-size:13px">
        <div id="emoji-grid" style="
          display:grid;grid-template-columns:repeat(auto-fill,minmax(38px,1fr));
          gap:4px;max-height:200px;overflow-y:auto;padding:4px
        "></div>
      </div>
    </div>
    <div class="card">
      <div id="wishes-list"></div>
    </div>
  </div>

  <!-- IDEAS -->
  <div class="page" id="page-ideas">

    <!-- Stats row -->
    <div id="ideas-stats-row" style="margin-bottom:16px;display:grid;grid-template-columns:repeat(4,1fr);gap:10px"></div>

    <!-- Add new idea -->
    <div class="card" id="ideas-add-card">
      <div class="section-header" style="margin-bottom:14px">
        <div class="section-title">ğŸ’¡ Ø§ÛŒØ¯Ù‡ Ø¬Ø¯ÛŒØ¯</div>
      </div>
      <div class="form-group">
        <input type="text" id="idea-title-input" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§ÛŒØ¯Ù‡..." style="width:100%;font-size:15px" onkeydown="if(event.key==='Enter')saveNewIdea()">
      </div>
      <div class="form-group">
        <textarea id="idea-desc-input" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª Ø¨ÛŒØ´ØªØ±... (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)" style="min-height:70px;width:100%"></textarea>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px">
        <select id="idea-cat-select" style="min-width:130px">
          <option value="Ú©Ø§Ø±">ğŸ’¼ Ú©Ø§Ø±</option>
          <option value="Ø´Ø®ØµÛŒ">ğŸ™‹ Ø´Ø®ØµÛŒ</option>
          <option value="Ù¾Ø±ÙˆÚ˜Ù‡">ğŸš€ Ù¾Ø±ÙˆÚ˜Ù‡</option>
          <option value="Ù…Ø­ØµÙˆÙ„">ğŸ“¦ Ù…Ø­ØµÙˆÙ„</option>
          <option value="Ø¢Ù…ÙˆØ²Ø´">ğŸ“š Ø¢Ù…ÙˆØ²Ø´</option>
          <option value="Ø¯ÛŒÚ¯Ø±">ğŸ’¬ Ø¯ÛŒÚ¯Ø±</option>
        </select>
        <select id="idea-priority-select">
          <option value="high">ğŸ”´ Ù…Ù‡Ù…</option>
          <option value="mid" selected>ğŸŸ¡ Ù…Ø¹Ù…ÙˆÙ„ÛŒ</option>
          <option value="low">âšª Ø¹Ø§Ø¯ÛŒ</option>
        </select>
        <input type="text" id="idea-tags-input" placeholder="Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§ (Ø¨Ø§ ÙˆÛŒØ±Ú¯ÙˆÙ„)" style="flex:1;min-width:130px">
        <div style="display:flex;gap:6px;align-items:center">
          <span style="font-size:12px;color:var(--text-muted)">Ø±Ù†Ú¯:</span>
          <div id="idea-color-picker" style="display:flex;gap:4px">
            <button class="idea-color-swatch active" data-color="#c8a96e" onclick="selectIdeaColor('#c8a96e',this)" style="width:22px;height:22px;border-radius:50%;background:#c8a96e;border:2px solid white;cursor:pointer"></button>
            <button class="idea-color-swatch" data-color="#5b9cf6" onclick="selectIdeaColor('#5b9cf6',this)" style="width:22px;height:22px;border-radius:50%;background:#5b9cf6;border:2px solid transparent;cursor:pointer"></button>
            <button class="idea-color-swatch" data-color="#4caf7d" onclick="selectIdeaColor('#4caf7d',this)" style="width:22px;height:22px;border-radius:50%;background:#4caf7d;border:2px solid transparent;cursor:pointer"></button>
            <button class="idea-color-swatch" data-color="#e05555" onclick="selectIdeaColor('#e05555',this)" style="width:22px;height:22px;border-radius:50%;background:#e05555;border:2px solid transparent;cursor:pointer"></button>
            <button class="idea-color-swatch" data-color="#7c6fcd" onclick="selectIdeaColor('#7c6fcd',this)" style="width:22px;height:22px;border-radius:50%;background:#7c6fcd;border:2px solid transparent;cursor:pointer"></button>
            <button class="idea-color-swatch" data-color="#888" onclick="selectIdeaColor('#888',this)" style="width:22px;height:22px;border-radius:50%;background:#888;border:2px solid transparent;cursor:pointer"></button>
          </div>
        </div>
      </div>
      <button class="btn btn-primary" onclick="saveNewIdea()">+ Ø°Ø®ÛŒØ±Ù‡ Ø§ÛŒØ¯Ù‡</button>
    </div>

    <!-- Search & filter -->
    <div class="card" style="padding:14px">
      <div style="display:flex;gap:8px;margin-bottom:10px">
        <input class="idea-search-bar" id="idea-search" placeholder="ğŸ” Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ø§ÛŒØ¯Ù‡â€ŒÙ‡Ø§..." oninput="renderIdeas()">
      </div>
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        <button class="idea-filter-btn active" data-filter="all" onclick="setIdeaFilter('all',this)">Ù‡Ù…Ù‡</button>
        <button class="idea-filter-btn" data-filter="pinned" onclick="setIdeaFilter('pinned',this)">ğŸ“Œ Ù¾ÛŒÙ†â€ŒØ´Ø¯Ù‡</button>
        <button class="idea-filter-btn" data-filter="new" onclick="setIdeaFilter('new',this)">ğŸ†• Ø¨Ø±Ø±Ø³ÛŒ Ù†Ø´Ø¯Ù‡</button>
        <button class="idea-filter-btn" data-filter="wip" onclick="setIdeaFilter('wip',this)">âš™ï¸ Ø¯Ø± Ø¬Ø±ÛŒØ§Ù†</button>
        <button class="idea-filter-btn" data-filter="done" onclick="setIdeaFilter('done',this)">âœ… Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯</button>
        <button class="idea-filter-btn" data-filter="high" onclick="setIdeaFilter('high',this)">ğŸ”´ Ù…Ù‡Ù…</button>
        <span style="width:1px;background:var(--border);margin:0 2px"></span>
        <button class="idea-filter-btn" data-cat="Ú©Ø§Ø±" onclick="setIdeaFilterCat('Ú©Ø§Ø±',this)">ğŸ’¼ Ú©Ø§Ø±</button>
        <button class="idea-filter-btn" data-cat="Ø´Ø®ØµÛŒ" onclick="setIdeaFilterCat('Ø´Ø®ØµÛŒ',this)">ğŸ™‹ Ø´Ø®ØµÛŒ</button>
        <button class="idea-filter-btn" data-cat="Ù¾Ø±ÙˆÚ˜Ù‡" onclick="setIdeaFilterCat('Ù¾Ø±ÙˆÚ˜Ù‡',this)">ğŸš€ Ù¾Ø±ÙˆÚ˜Ù‡</button>
        <button class="idea-filter-btn" data-cat="Ù…Ø­ØµÙˆÙ„" onclick="setIdeaFilterCat('Ù…Ø­ØµÙˆÙ„',this)">ğŸ“¦ Ù…Ø­ØµÙˆÙ„</button>
        <button class="idea-filter-btn" data-cat="Ø¢Ù…ÙˆØ²Ø´" onclick="setIdeaFilterCat('Ø¢Ù…ÙˆØ²Ø´',this)">ğŸ“š Ø¢Ù…ÙˆØ²Ø´</button>
      </div>
    </div>

    <!-- Ideas list -->
    <div id="ideas-list"></div>
  </div>

  <!-- MEETINGS -->
  <div class="page" id="page-meetings">
    <div class="card">
      <button class="btn btn-primary" onclick="openModal('meeting')">+ Ø¬Ù„Ø³Ù‡ Ø¬Ø¯ÛŒØ¯</button>
    </div>
    <div id="meetings-list"></div>
  </div>

</div>

<!-- CALENDAR MONTH/YEAR PICKER -->
<div id="cal-picker-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:300;align-items:center;justify-content:center">
  <div id="cal-picker-content" style="background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:24px;width:320px;font-family:Vazirmatn,sans-serif;direction:rtl"></div>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modal">
  <div class="modal" id="modal-content"></div>
</div>

<!-- DATE PICKER OVERLAY -->
<div id="date-picker-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:300;align-items:center;justify-content:center;direction:rtl">
  <div id="date-picker-content"></div>
</div>

<!-- TIME PICKER OVERLAY -->
<div id="time-picker-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:300;align-items:center;justify-content:center">
  <div id="time-picker-content"></div>
</div>

<script>
// â”€â”€â”€ JALALI CALENDAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const J = {
  // Gregorian to Jalali
  toJalali(gy, gm, gd) {
    let g_d_no, j_d_no, j_np, i;
    const g_days_in_month = [31,28,31,30,31,30,31,31,30,31,30,31];
    const j_days_in_month = [31,31,31,31,31,31,30,30,30,30,30,29];
    gy -= 1600; gm -= 1; gd -= 1;
    g_d_no = 365*gy + Math.floor((gy+3)/4) - Math.floor((gy+99)/100) + Math.floor((gy+399)/400);
    for(i=0;i<gm;i++) g_d_no += g_days_in_month[i];
    if(gm>1 && ((gy%4==0 && gy%100!=0) || (gy%400==0))) g_d_no++;
    g_d_no += gd;
    j_d_no = g_d_no - 79;
    j_np = Math.floor(j_d_no/12053); j_d_no %= 12053;
    let jy = 979 + 33*j_np + 4*Math.floor(j_d_no/1461);
    j_d_no %= 1461;
    if(j_d_no >= 366){ jy += Math.floor((j_d_no-1)/365); j_d_no = (j_d_no-1)%365; }
    for(i=0; i<11 && j_d_no >= j_days_in_month[i]; i++) j_d_no -= j_days_in_month[i];
    return [jy, i+1, j_d_no+1];
  },
  // Jalali to Gregorian
  toGregorian(jy, jm, jd) {
    let i, j_d_no, gy, gd;
    const j_days_in_month = [31,31,31,31,31,31,30,30,30,30,30,29];
    const g_days_in_month = [31,28,31,30,31,30,31,31,30,31,30,31];
    jy -= 979; jm -= 1; jd -= 1;
    j_d_no = 365*jy + Math.floor(jy/33)*8 + Math.floor((jy%33+3)/4);
    for(i=0;i<jm;i++) j_d_no += j_days_in_month[i];
    j_d_no += jd;
    let g_d_no = j_d_no + 79;
    let gy0 = 1600 + 400*Math.floor(g_d_no/146097); g_d_no %= 146097;
    let leap = true;
    if(g_d_no >= 36525){ g_d_no--; gy0 += 100*Math.floor(g_d_no/36524); g_d_no %= 36524;
      if(g_d_no >= 365) g_d_no++; else leap = false; }
    gy0 += 4*Math.floor(g_d_no/1461); g_d_no %= 1461;
    if(g_d_no >= 366){ leap = false; g_d_no--; gy0 += Math.floor(g_d_no/365); g_d_no %= 365; }
    for(i=0; g_d_no >= g_days_in_month[i] + (i==1 && leap ? 1:0); i++) g_d_no -= g_days_in_month[i] + (i==1 && leap?1:0);
    return [gy0, i+1, g_d_no+1];
  },
  // today as Jalali array
  todayJ() { const d=new Date(); return this.toJalali(d.getFullYear(),d.getMonth()+1,d.getDate()); },
  // Jalali date string YYYY/MM/DD â†’ store key
  jStrToKey(s) { return s.replace(/\//g,'-'); },
  keyToJStr(s) { return s.replace(/-/g,'/'); },
  // Parse jalali string "1403/06/15" â†’ [y,m,d]
  parseJ(s) { return s.split('/').map(Number); },
  // Format jalali for display
  monthNames: ['ÙØ±ÙˆØ±Ø¯ÛŒÙ†','Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª','Ø®Ø±Ø¯Ø§Ø¯','ØªÛŒØ±','Ù…Ø±Ø¯Ø§Ø¯','Ø´Ù‡Ø±ÛŒÙˆØ±','Ù…Ù‡Ø±','Ø¢Ø¨Ø§Ù†','Ø¢Ø°Ø±','Ø¯ÛŒ','Ø¨Ù‡Ù…Ù†','Ø§Ø³ÙÙ†Ø¯'],
  weekDayNames: ['Ø´Ù†Ø¨Ù‡','ÛŒÚ©Ø´Ù†Ø¨Ù‡','Ø¯ÙˆØ´Ù†Ø¨Ù‡','Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡','Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡','Ù¾Ù†Ø¬Ø´Ù†Ø¨Ù‡','Ø¬Ù…Ø¹Ù‡'],
  weekDayShort: ['Ø´','ÛŒ','Ø¯','Ø³','Ú†','Ù¾','Ø¬'],
  
  displayDate(key) { // key is YYYY-MM-DD gregorian internally OR jalali YYYY-MM-DD
    // We store as jalali key internally now
    const parts = key.split('-').map(Number);
    if(parts[0] > 1500) {
      // gregorian, convert
      const [jy,jm,jd] = this.toJalali(parts[0],parts[1],parts[2]);
      const gDate = new Date(parts[0],parts[1]-1,parts[2]);
      const dow = this.weekDayNames[(gDate.getDay()+1)%7];
      return `${dow} ${jd} ${this.monthNames[jm-1]} ${jy}`;
    } else {
      // jalali key
      const [jy,jm,jd] = parts;
      const [gy,gm,gd] = this.toGregorian(jy,jm,jd);
      const gDate = new Date(gy,gm-1,gd);
      const dow = this.weekDayNames[(gDate.getDay()+1)%7];
      return `${dow} ${jd} ${this.monthNames[jm-1]} ${jy}`;
    }
  },
  // Get today as storage key (jalali)
  todayKey() {
    const [jy,jm,jd] = this.todayJ();
    return `${jy}-${String(jm).padStart(2,'0')}-${String(jd).padStart(2,'0')}`;
  },
  // Compare two jalali keys
  compareKeys(a,b) { return a > b ? 1 : a < b ? -1 : 0; },
  // Gregorian date to jalali key
  gDateToKey(d) {
    const [jy,jm,jd] = this.toJalali(d.getFullYear(),d.getMonth()+1,d.getDate());
    return `${jy}-${String(jm).padStart(2,'0')}-${String(jd).padStart(2,'0')}`;
  },
  // Jalali key to Gregorian Date object
  keyToGDate(key) {
    const [jy,jm,jd] = key.split('-').map(Number);
    const [gy,gm,gdd] = this.toGregorian(jy,jm,jd);
    return new Date(gy,gm-1,gdd);
  }
};

// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const state = {
  todos: [],
  goals: [],
  wishes: [],
  meetings: [],
  journal: [],
  ideas: []
};

let selectedMood = '';

// Load from localStorage
function load() {
  ['todos','goals','wishes','meetings','journal','ideas'].forEach(k => {
    try { state[k] = JSON.parse(localStorage.getItem('brain_'+k)) || []; } catch(e) { state[k] = []; }
  });
}

function save(key) {
  localStorage.setItem('brain_'+key, JSON.stringify(state[key]));
}

// â”€â”€â”€ DATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function todayStr() { return J.todayKey(); }
function displayDate(d) { return J.displayDate(d); }

function initDates() {
  const [jy,jm,jd] = J.todayJ();
  document.getElementById('headerDate').textContent = `${jd} ${J.monthNames[jm-1]} ${jy}`;
  document.getElementById('journal-today-date').textContent = displayDate(todayStr());
}

// â”€â”€â”€ WEEK GRID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let selectedWeekDay = null; // jalali key of selected day, null = today
let weekOffset = 0; // 0 = current week, -1 = last week, +1 = next week

function navigateWeek(dir) {
  weekOffset += dir;
  selectedWeekDay = null;
  buildWeekGrid();
}

function buildWeekGrid() {
  const grid = document.getElementById('weekGrid');
  grid.innerHTML = '';

  const today = new Date();
  const todayKey = J.gDateToKey(today);

  // Find Saturday of the current week, then offset by weekOffset * 7
  const dayOfWeek = today.getDay();
  const sinceLastSat = (dayOfWeek === 6) ? 0 : dayOfWeek + 1;
  const weekStart = new Date(today);
  weekStart.setDate(today.getDate() - sinceLastSat + weekOffset * 7);

  // Show month/year label
  const [jy0, jm0] = J.toJalali(weekStart.getFullYear(), weekStart.getMonth()+1, weekStart.getDate());
  // Check if week spans two months
  const weekEnd = new Date(weekStart);
  weekEnd.setDate(weekStart.getDate() + 6);
  const [jy1, jm1] = J.toJalali(weekEnd.getFullYear(), weekEnd.getMonth()+1, weekEnd.getDate());
  const monthLabel = document.getElementById('week-month-label');
  if (monthLabel) {
    if (jm0 !== jm1) {
      monthLabel.textContent = J.monthNames[jm0-1] + ' / ' + J.monthNames[jm1-1] + ' ' + jy0;
    } else {
      monthLabel.textContent = J.monthNames[jm0-1] + ' ' + jy0;
    }
    // Add "Ø§ÛŒÙ† Ù‡ÙØªÙ‡" badge if on current week
    if (weekOffset === 0) {
      monthLabel.innerHTML += ' <span style="font-size:10px;background:rgba(200,169,110,0.2);border:1px solid var(--accent);border-radius:99px;padding:1px 7px;vertical-align:middle">Ø§ÛŒÙ† Ù‡ÙØªÙ‡</span>';
    }
  }

  const fullDayNames = ['Ø´Ù†Ø¨Ù‡','ÛŒÚ©Ø´Ù†Ø¨Ù‡','Ø¯ÙˆØ´Ù†Ø¨Ù‡','Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡','Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡','Ù¾Ù†Ø¬Ø´Ù†Ø¨Ù‡','Ø¬Ù…Ø¹Ù‡'];

  for (let i = 0; i < 7; i++) {
    const d = new Date(weekStart);
    d.setDate(weekStart.getDate() + i);
    const dKey = J.gDateToKey(d);
    const [jy, jm, jd] = J.toJalali(d.getFullYear(), d.getMonth()+1, d.getDate());
    const hasEntry = state.journal.some(j => j.date === dKey);
    const isToday = dKey === todayKey;
    const isSelected = dKey === (selectedWeekDay || (weekOffset === 0 ? todayKey : null));

    const el = document.createElement('div');
    el.className = 'week-day' + (isToday ? ' today' : '') + (isSelected ? ' selected-day' : '');
    el.style.cursor = 'pointer';
    el.innerHTML = `
      <div class="week-day-name" style="font-size:9px">${fullDayNames[i]}</div>
      <div class="week-day-num">${jd}</div>
      ${hasEntry ? '<div class="week-dot"></div>' : '<div style="height:5px"></div>'}
    `;
    el.addEventListener('click', () => selectWeekDay(dKey));
    grid.appendChild(el);
  }

  renderDashboardTodos();
}

function selectWeekDay(key) {
  selectedWeekDay = key;
  buildWeekGrid();
}

function renderDashboardTodos() {
  const dash = document.getElementById('dashboard-todos');
  const titleEl = document.getElementById('dashboard-todos-title');
  if (!dash) return;

  const todayKey = J.gDateToKey(new Date());
  const targetKey = selectedWeekDay || todayKey;
  const isToday = targetKey === todayKey;

  if (titleEl) {
    if (isToday) {
      titleEl.textContent = 'Ú©Ø§Ø±Ù‡Ø§ÛŒ Ù…Ù‡Ù… Ø§Ù…Ø±ÙˆØ²';
    } else {
      const [jy, jm, jd] = targetKey.split('-').map(Number);
      titleEl.textContent = 'Ú©Ø§Ø±Ù‡Ø§ÛŒ Ù…Ù‡Ù… ' + jd + ' ' + J.monthNames[jm-1];
    }
  }

  // Show high priority todos that are either due on this day OR (for today) have no due date
  let urgent;
  if (isToday) {
    urgent = state.todos.filter(t => !t.done && t.priority === 'high').slice(0, 5);
  } else {
    urgent = state.todos.filter(t => !t.done && t.priority === 'high' && t.dueDate === targetKey).slice(0, 5);
    if (!urgent.length) {
      // fallback: show all high priority if none due on that day
      urgent = state.todos.filter(t => !t.done && t.priority === 'high').slice(0, 5);
    }
  }

  if (!urgent.length) {
    dash.innerHTML = '<div class="empty-state" style="padding:20px"><div class="empty-emoji">âœ¨</div>Ù‡ÛŒÚ† Ú©Ø§Ø± ÙÙˆØ±ÛŒâ€ŒØ§ÛŒ Ù†Ø¯Ø§Ø±ÛŒ!</div>';
    return;
  }

  const today = todayKey;
  function dueDateBadge(t) {
    if (!t.dueDate && !t.dueTime) return '';
    const isOverdue = !t.done && t.dueDate && J.compareKeys(t.dueDate, today) < 0;
    const color = isOverdue ? 'var(--red)' : 'var(--text-muted)';
    const icon = isOverdue ? 'âš ï¸' : 'ğŸ“…';
    let label = '';
    if (t.dueDate) {
      const [jy,jm,jd] = t.dueDate.split('-').map(Number);
      label += icon + ' ' + jd + ' ' + J.monthNames[jm-1];
    }
    if (t.dueTime) label += (label ? ' Â· ' : 'ğŸ• ') + t.dueTime;
    return '<span style="font-size:11px;color:' + color + ';margin-right:6px">' + label + '</span>';
  }

  dash.innerHTML = urgent.map(t => `
    <div class="todo-item">
      <div class="priority-dot p-high"></div>
      <div class="todo-check ${t.done?'checked':''}" onclick="toggleTodo(${t.id})">${t.done?'âœ“':''}</div>
      <div class="todo-text">
        <div>${t.text}</div>
        <div style="margin-top:3px">${dueDateBadge(t)}</div>
      </div>
    </div>
  `).join('');
}


// â”€â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(tab) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('page-'+tab).classList.add('active');
  const tabs = ['dashboard','calendar','journal','todos','goals','wishes','meetings','ideas'];
  document.querySelectorAll('.tab')[tabs.indexOf(tab)].classList.add('active');
  renderAll();
}

// â”€â”€â”€ JOURNAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selectMood(btn, mood) {
  document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  selectedMood = mood;
}

function setJournalTimeNow() {
  var now = new Date();
  var h = String(now.getHours()).padStart(2,'0');
  var m = String(now.getMinutes()).padStart(2,'0');
  document.getElementById('journal-time').value = h + ':' + m;
}

function saveJournal() {
  const text = document.getElementById('journal-text').value.trim();
  if (!text) return;
  
  const entry = {
    id: Date.now(),
    date: todayStr(),
    time: document.getElementById('journal-time').value.trim(),
    text,
    mood: selectedMood
  };
  
  state.journal.unshift(entry);
  save('journal');

  document.getElementById('journal-text').value = '';
  document.getElementById('journal-time').value = '';
  selectedMood = '';
  document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected'));
  renderJournal();
  updateStats();
  document.getElementById('weekGrid').innerHTML = '';
  buildWeekGrid();
}

function deleteJournalEntry(id) {
  state.journal = state.journal.filter(j => j.id !== id);
  save('journal');
  renderJournal();
  updateStats();
  document.getElementById('weekGrid').innerHTML = '';
  buildWeekGrid();
}

function renderJournalSummary() {
  const el = document.getElementById('journal-summary-content');
  if (!el) return;

  const MOOD_SCORE = { 'ğŸ˜':5, 'ğŸ™‚':4, 'ğŸ˜':3, 'ğŸ˜”':2, 'ğŸ˜¤':2, 'ğŸ˜°':1 };
  const MOOD_LABEL = { 5:'Ø¹Ø§Ù„ÛŒ ğŸ˜', 4:'Ø®ÙˆØ¨ ğŸ™‚', 3:'Ù…Ø¹Ù…ÙˆÙ„ÛŒ ğŸ˜', 2:'Ø¨Ø¯ ğŸ˜”', 1:'Ø®ÛŒÙ„ÛŒ Ø¨Ø¯ ğŸ˜°' };
  const MOOD_COLOR = { 5:'#4caf7d', 4:'#8bc34a', 3:'#c8a96e', 2:'#e08c3a', 1:'#e05555' };

  // helpers
  function getKeys(daysBack) {
    var keys = [];
    for (var i = 0; i < daysBack; i++) {
      var d = new Date(); d.setDate(d.getDate() - i);
      keys.push(J.gDateToKey(d));
    }
    return keys;
  }

  function avgMood(entries) {
    var scored = entries.filter(j => j.mood && MOOD_SCORE[j.mood]);
    if (!scored.length) return null;
    return scored.reduce((s,j) => s + MOOD_SCORE[j.mood], 0) / scored.length;
  }

  function dominantMood(entries) {
    var counts = {};
    entries.forEach(j => { if (j.mood) counts[j.mood] = (counts[j.mood]||0)+1; });
    var best = Object.entries(counts).sort((a,b)=>b[1]-a[1])[0];
    return best ? best[0] : null;
  }

  // Get jalali current month range
  var [jy, jm] = J.todayJ();
  var monthKeys = [];
  var daysInMonth = [0,31,31,31,31,31,31,30,30,30,30,30,29][jm];
  for (var d = 1; d <= daysInMonth; d++) {
    monthKeys.push(jy + '-' + String(jm).padStart(2,'0') + '-' + String(d).padStart(2,'0'));
  }

  var todayKey = todayStr();
  var todayEntries   = state.journal.filter(j => j.date === todayKey);
  var weekEntries    = state.journal.filter(j => getKeys(7).includes(j.date));
  var monthEntries   = state.journal.filter(j => monthKeys.includes(j.date));

  // unique days written
  var weekDays  = new Set(weekEntries.map(j=>j.date)).size;
  var monthDays = new Set(monthEntries.map(j=>j.date)).size;

  function moodBar(avg) {
    if (!avg) return '<span style="color:var(--text-muted);font-size:12px">â€”</span>';
    var pct = ((avg-1)/4)*100;
    var col = MOOD_COLOR[Math.round(avg)];
    return '<div style="display:flex;align-items:center;gap:8px">'
      + '<div style="flex:1;height:6px;background:var(--border);border-radius:99px;overflow:hidden">'
      + '<div style="height:100%;width:' + pct + '%;background:' + col + ';border-radius:99px;transition:width 0.5s"></div>'
      + '</div>'
      + '<span style="font-size:12px;color:' + col + ';font-weight:700;min-width:60px">' + (MOOD_LABEL[Math.round(avg)]||'â€”') + '</span>'
      + '</div>';
  }

  function sectionBlock(label, entries, daysLabel) {
    var avg = avgMood(entries);
    var dom = dominantMood(entries);
    var count = entries.length;
    if (!count) return '<div style="color:var(--text-muted);font-size:12px">Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</div>';
    return '<div style="margin-top:4px">'
      + moodBar(avg)
      + '<div style="font-size:11px;color:var(--text-muted);margin-top:4px">' + count + ' ÙˆØ±ÙˆØ¯ÛŒ' + (daysLabel ? ' Â· ' + daysLabel : '') + '</div>'
      + '</div>';
  }

  // today mood timeline
  var todayMoodLine = '';
  if (todayEntries.length) {
    var sorted = [...todayEntries].sort((a,b) => (a.time||'') > (b.time||'') ? 1 : -1);
    todayMoodLine = '<div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:6px">'
      + sorted.map(j => {
          var timeStr = j.time ? '<span style="font-size:10px;color:var(--text-muted);display:block">' + j.time + '</span>' : '';
          return '<div style="text-align:center;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:6px 10px">'
            + '<div style="font-size:20px">' + (j.mood||'ğŸ“') + '</div>'
            + timeStr
            + '</div>';
        }).join('')
      + '</div>';
  }

  // week mood per day (last 7 days as bars)
  var weekBarHtml = '<div style="display:flex;gap:4px;align-items:flex-end;height:50px;margin-top:8px">';
  var last7Keys = getKeys(7).reverse();
  last7Keys.forEach(function(key) {
    var dayEntries = state.journal.filter(j => j.date === key);
    var avg = avgMood(dayEntries);
    var pct = avg ? ((avg-1)/4)*100 : 0;
    var col = avg ? (MOOD_COLOR[Math.round(avg)] || 'var(--border)') : 'var(--border)';
    var parts = key.split('-');
    var dayNum = parseInt(parts[2]);
    var isToday = key === todayKey;
    weekBarHtml += '<div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:3px">'
      + '<div style="width:100%;background:var(--border);border-radius:4px 4px 0 0;height:40px;display:flex;align-items:flex-end;overflow:hidden">'
      + '<div style="width:100%;height:' + pct + '%;background:' + col + ';border-radius:4px 4px 0 0;transition:height 0.5s;min-height:' + (avg?'4px':'0') + '"></div>'
      + '</div>'
      + '<div style="font-size:10px;color:' + (isToday?'var(--accent)':'var(--text-muted)') + ';font-weight:' + (isToday?700:400) + '">' + dayNum + '</div>'
      + '</div>';
  });
  weekBarHtml += '</div>';

  el.innerHTML = '<div style="font-size:14px;font-weight:700;color:var(--text);margin-bottom:14px">ğŸ“Š Ø®Ù„Ø§ØµÙ‡ Ú˜ÙˆØ±Ù†Ø§Ù„</div>'

    + '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:16px">'

    // Ø§Ù…Ø±ÙˆØ²
    + '<div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:12px">'
    + '<div style="font-size:11px;font-weight:700;color:var(--accent);margin-bottom:6px">Ø§Ù…Ø±ÙˆØ²</div>'
    + (todayEntries.length ? sectionBlock('Ø§Ù…Ø±ÙˆØ²', todayEntries, '') : '<div style="color:var(--text-muted);font-size:12px">Ù‡Ù†ÙˆØ² Ù†Ù†ÙˆØ´ØªÛŒ</div>')
    + '</div>'

    // Ù‡ÙØªÙ‡
    + '<div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:12px">'
    + '<div style="font-size:11px;font-weight:700;color:var(--accent);margin-bottom:6px">Ù‡ÙØª Ø±ÙˆØ²</div>'
    + sectionBlock('Ù‡ÙØªÙ‡', weekEntries, weekDays + '/Û· Ø±ÙˆØ²')
    + '</div>'

    // Ù…Ø§Ù‡
    + '<div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:12px">'
    + '<div style="font-size:11px;font-weight:700;color:var(--accent);margin-bottom:6px">' + J.monthNames[jm-1] + '</div>'
    + sectionBlock('Ù…Ø§Ù‡', monthEntries, monthDays + '/' + daysInMonth + ' Ø±ÙˆØ²')
    + '</div>'

    + '</div>'

    // timeline Ø§Ù…Ø±ÙˆØ²
    + (todayEntries.length ? '<div style="margin-bottom:16px"><div style="font-size:11px;color:var(--text-muted);margin-bottom:4px">Ø±ÙˆÙ†Ø¯ Ø­Ø§Ù„ Ø§Ù…Ø±ÙˆØ²</div>' + todayMoodLine + '</div>' : '')

    // Ù†Ù…ÙˆØ¯Ø§Ø± Ù‡ÙØªÙ‡
    + '<div><div style="font-size:11px;color:var(--text-muted);margin-bottom:2px">Ù†Ù…ÙˆØ¯Ø§Ø± Û· Ø±ÙˆØ² Ú¯Ø°Ø´ØªÙ‡</div>' + weekBarHtml + '</div>';
}

function renderJournal() {
  renderJournalSummary();
  const list = document.getElementById('journal-list');
  if (!list) return;
  if (!state.journal.length) {
    list.innerHTML = '<div class="empty-state"><div class="empty-emoji">ğŸ“</div>Ù‡Ù†ÙˆØ² Ú†ÛŒØ²ÛŒ Ù†Ù†ÙˆØ´ØªÛŒ</div>';
    return;
  }

  // Group by date
  const groups = {};
  state.journal.forEach(j => {
    if (!groups[j.date]) groups[j.date] = [];
    groups[j.date].push(j);
  });

  const sortedDates = Object.keys(groups).sort((a,b) => b > a ? 1 : -1);

  list.innerHTML = sortedDates.map(date => {
    const entries = groups[date].sort((a,b) => {
      // sort by time if available, else by id
      if (a.time && b.time) return a.time > b.time ? 1 : -1;
      return b.id - a.id;
    });
    const isToday = date === todayStr();

    const entriesHtml = entries.map(j => {
      const timeLabel = j.time
        ? '<span style="font-size:11px;background:var(--surface);border:1px solid var(--border);border-radius:99px;padding:2px 8px;margin-left:8px">ğŸ• ' + j.time + '</span>'
        : '';
      const moodLabel = j.mood
        ? '<span style="font-size:16px;margin-left:4px">' + j.mood + '</span>'
        : '';
      return '<div style="position:relative;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:12px 14px;margin-bottom:8px">'
        + '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">'
        + '<div style="display:flex;align-items:center;gap:4px">' + moodLabel + timeLabel + '</div>'
        + '<button onclick="deleteJournalEntry(' + j.id + ')" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:13px;padding:2px 6px;border-radius:4px" onmouseover="this.style.color=\'var(--red)\'" onmouseout="this.style.color=\'var(--text-muted)\'">âœ•</button>'
        + '</div>'
        + '<div style="font-size:14px;line-height:1.7;color:var(--text);white-space:pre-wrap">' + j.text.replace(/</g,'&lt;') + '</div>'
        + '</div>';
    }).join('');

    return '<div style="margin-bottom:20px">'
      + '<div style="font-size:12px;font-weight:700;color:' + (isToday ? 'var(--accent)' : 'var(--text-muted)') + ';margin-bottom:8px;display:flex;align-items:center;gap:8px">'
      + displayDate(date)
      + (isToday ? '<span style="background:rgba(200,169,110,0.2);border:1px solid var(--accent);border-radius:99px;padding:1px 8px;font-size:10px">Ø§Ù…Ø±ÙˆØ²</span>' : '')
      + '<span style="color:var(--border)">(' + entries.length + ' ÙˆØ±ÙˆØ¯ÛŒ)</span>'
      + '</div>'
      + entriesHtml
      + '</div>';
  }).join('');
}

// â”€â”€â”€ TODOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addTodo() {
  const input = document.getElementById('todo-input');
  const text = input.value.trim();
  if (!text) return;
  
  const tag = document.getElementById('todo-tag').value.trim();
  const priority = document.getElementById('todo-priority').value;
  const dateRaw = document.getElementById('todo-date').value.trim();
  const dueDate = dateRaw ? dateRaw.replace(/\//g,'-') : '';
  const dueTime = document.getElementById('todo-time').value.trim();
  
  state.todos.unshift({ id: Date.now(), text, priority, tag, dueDate, dueTime, done: false });
  save('todos');
  input.value = '';
  document.getElementById('todo-tag').value = '';
  document.getElementById('todo-date').value = '';
  document.getElementById('todo-time').value = '';
  renderTodos();
  updateStats();
}

function toggleTodo(id) {
  const t = state.todos.find(t => t.id === id);
  if (t) { t.done = !t.done; save('todos'); renderTodos(); updateStats(); }
}

function deleteTodo(id) {
  state.todos = state.todos.filter(t => t.id !== id);
  save('todos'); renderTodos(); updateStats();
}

function openEditTodo(id) {
  const t = state.todos.find(t => t.id === id);
  if (!t) return;
  const content = document.getElementById('modal-content');
  const dueDateDisplay = t.dueDate ? t.dueDate.replace(/-/g,'/') : '';
  const dueTimeDisplay = t.dueTime || '';
  content.innerHTML = `
    <div class="modal-title">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ø±</div>
    <div class="form-group">
      <label class="form-label">Ù…ØªÙ† Ú©Ø§Ø± *</label>
      <input type="text" id="edit-todo-text" value="${t.text.replace(/"/g,'&quot;')}" style="width:100%">
    </div>
    <div class="form-group">
      <label class="form-label">Ø§ÙˆÙ„ÙˆÛŒØª</label>
      <select id="edit-todo-priority" style="width:100%">
        <option value="high" ${t.priority==='high'?'selected':''}>ğŸ”´ ÙÙˆØ±ÛŒ</option>
        <option value="mid" ${t.priority==='mid'?'selected':''}>ğŸŸ¡ Ù…Ø¹Ù…ÙˆÙ„ÛŒ</option>
        <option value="low" ${t.priority==='low'?'selected':''}>ğŸŸ¢ Ø²Ù…Ø§Ù†ÛŒ</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Ø¨Ø±Ú†Ø³Ø¨</label>
      <input type="text" id="edit-todo-tag" value="${t.tag||''}" placeholder="Ø¨Ø±Ú†Ø³Ø¨ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)" style="width:100%">
    </div>
    <div class="form-group">
      <label class="form-label">Ø³Ø±Ø±Ø³ÛŒØ¯</label>
      <div style="display:flex;gap:8px">
        <input type="text" id="edit-todo-date" value="${dueDateDisplay}" placeholder="ØªØ§Ø±ÛŒØ®" readonly style="flex:1;cursor:pointer" onclick="openPicker('edit-todo-date')">
        <button type="button" class="btn btn-ghost" onclick="openPicker('edit-todo-date')" style="padding:10px 12px">ğŸ“…</button>
        <button type="button" class="btn btn-ghost" onclick="document.getElementById('edit-todo-date').value=''" style="padding:10px 12px;color:var(--red)">âœ•</button>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Ø³Ø§Ø¹Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
      <div style="display:flex;gap:8px">
        <input type="text" id="edit-todo-time" value="${dueTimeDisplay}" placeholder="--:--" readonly style="flex:1;cursor:pointer" onclick="openTimePicker('edit-todo-time')">
        <button type="button" class="btn btn-ghost" onclick="openTimePicker('edit-todo-time')" style="padding:10px 12px">ğŸ•</button>
        <button type="button" class="btn btn-ghost" onclick="document.getElementById('edit-todo-time').value=''" style="padding:10px 12px;color:var(--red)">âœ•</button>
      </div>
    </div>
    <div style="display:flex;gap:8px;margin-top:4px">
      <button class="btn btn-primary" onclick="saveEditTodo(${id})">Ø°Ø®ÛŒØ±Ù‡</button>
      <button class="btn btn-ghost" onclick="closeModal()">Ø§Ù†ØµØ±Ø§Ù</button>
    </div>
  `;
  document.getElementById('modal').classList.add('open');
}

function saveEditTodo(id) {
  const t = state.todos.find(t => t.id === id);
  if (!t) return;
  const text = document.getElementById('edit-todo-text').value.trim();
  if (!text) return;
  t.text = text;
  t.priority = document.getElementById('edit-todo-priority').value;
  t.tag = document.getElementById('edit-todo-tag').value.trim();
  const dateRaw = document.getElementById('edit-todo-date').value.trim();
  t.dueDate = dateRaw ? dateRaw.replace(/\//g,'-') : '';
  t.dueTime = document.getElementById('edit-todo-time').value.trim();
  save('todos');
  closeModal();
  renderTodos();
}

function clearDone() {
  state.todos = state.todos.filter(t => !t.done);
  save('todos'); renderTodos(); updateStats();
}

function renderTodosSummary() {
  const el = document.getElementById('todos-summary-content');
  if (!el) return;

  const all = state.todos;
  const done = all.filter(t => t.done);
  const active = all.filter(t => !t.done);
  const high = active.filter(t => t.priority === 'high');
  const mid  = active.filter(t => t.priority === 'mid');
  const low  = active.filter(t => t.priority === 'low');
  const total = all.length;
  const donePercent = total ? Math.round((done.length / total) * 100) : 0;

  // Overdue
  const today = todayStr();
  const overdue = active.filter(t => t.dueDate && J.compareKeys(t.dueDate, today) < 0);

  // Due today
  const dueToday = active.filter(t => t.dueDate && t.dueDate === today);

  if (!total) {
    el.innerHTML = '<div style="color:var(--text-muted);font-size:13px;text-align:center;padding:8px">Ù‡Ù†ÙˆØ² Ú©Ø§Ø±ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</div>';
    return;
  }

  el.innerHTML = `
    <div style="display:flex;gap:16px;flex-wrap:wrap;margin-bottom:16px;align-items:flex-end">
      <div>
        <div style="font-size:32px;font-weight:900;color:var(--accent);line-height:1">${donePercent}%</div>
        <div style="font-size:11px;color:var(--text-muted);margin-top:2px">Ù¾ÛŒØ´Ø±ÙØª Ú©Ù„ÛŒ</div>
      </div>
      <div style="flex:1;min-width:120px">
        <div style="height:8px;background:var(--border);border-radius:99px;overflow:hidden;margin-bottom:6px">
          <div style="height:100%;width:${donePercent}%;background:linear-gradient(90deg,var(--accent2),var(--accent));border-radius:99px;transition:width 0.5s"></div>
        </div>
        <div style="font-size:11px;color:var(--text-muted)">${done.length} Ø§Ø² ${total} Ú©Ø§Ø± Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡</div>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:10px;margin-bottom:${overdue.length||dueToday.length?'14px':'0'}">
      <div style="background:var(--surface2);border-radius:8px;padding:10px;text-align:center;border:1px solid var(--border)">
        <div style="font-size:20px;font-weight:800;color:var(--red)">${high.length}</div>
        <div style="font-size:10px;color:var(--text-muted);margin-top:2px">ğŸ”´ ÙÙˆØ±ÛŒ</div>
      </div>
      <div style="background:var(--surface2);border-radius:8px;padding:10px;text-align:center;border:1px solid var(--border)">
        <div style="font-size:20px;font-weight:800;color:var(--accent)">${mid.length}</div>
        <div style="font-size:10px;color:var(--text-muted);margin-top:2px">ğŸŸ¡ Ù…Ø¹Ù…ÙˆÙ„ÛŒ</div>
      </div>
      <div style="background:var(--surface2);border-radius:8px;padding:10px;text-align:center;border:1px solid var(--border)">
        <div style="font-size:20px;font-weight:800;color:var(--green)">${low.length}</div>
        <div style="font-size:10px;color:var(--text-muted);margin-top:2px">ğŸŸ¢ Ø²Ù…Ø§Ù†ÛŒ</div>
      </div>
      <div style="background:var(--surface2);border-radius:8px;padding:10px;text-align:center;border:1px solid var(--border)">
        <div style="font-size:20px;font-weight:800;color:var(--green)">${done.length}</div>
        <div style="font-size:10px;color:var(--text-muted);margin-top:2px">âœ… ØªÙ…ÙˆÙ… Ø´Ø¯Ù‡</div>
      </div>
    </div>

    ${overdue.length ? `
      <div style="background:rgba(224,85,85,0.08);border:1px solid rgba(224,85,85,0.3);border-radius:8px;padding:10px;margin-bottom:8px">
        <div style="font-size:12px;font-weight:700;color:var(--red);margin-bottom:6px">âš ï¸ ${overdue.length} Ú©Ø§Ø± Ø¯ÛŒØ± Ø´Ø¯Ù‡</div>
        ${overdue.slice(0,3).map(t=>`<div style="font-size:12px;color:var(--text-muted);padding:2px 0">â€¢ ${t.text}</div>`).join('')}
        ${overdue.length>3?`<div style="font-size:11px;color:var(--text-muted);margin-top:4px">Ùˆ ${overdue.length-3} Ù…ÙˆØ±Ø¯ Ø¯ÛŒÚ¯Ù‡...</div>`:''}
      </div>` : ''}

    ${dueToday.length ? `
      <div style="background:rgba(200,169,110,0.08);border:1px solid rgba(200,169,110,0.3);border-radius:8px;padding:10px">
        <div style="font-size:12px;font-weight:700;color:var(--accent);margin-bottom:6px">ğŸ“… ${dueToday.length} Ú©Ø§Ø± Ø¨Ø±Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²</div>
        ${dueToday.slice(0,3).map(t=>`<div style="font-size:12px;color:var(--text-muted);padding:2px 0">â€¢ ${t.text}</div>`).join('')}
        ${dueToday.length>3?`<div style="font-size:11px;color:var(--text-muted);margin-top:4px">Ùˆ ${dueToday.length-3} Ù…ÙˆØ±Ø¯ Ø¯ÛŒÚ¯Ù‡...</div>`:''}
      </div>` : ''}
  `;
}

function renderTodos() {
  renderTodosSummary();
  const today = todayStr();
  const groups = { high: [], mid: [], low: [], done: [] };
  state.todos.forEach(t => {
    if (t.done) groups.done.push(t);
    else groups[t.priority].push(t);
  });
  
  const pClasses = { high:'p-high', mid:'p-mid', low:'p-low' };

  function dueDateBadge(t) {
    if (!t.dueDate && !t.dueTime) return '';
    const isOverdue = !t.done && t.dueDate && J.compareKeys(t.dueDate, today) < 0;
    const color = isOverdue ? 'var(--red)' : 'var(--text-muted)';
    const icon = isOverdue ? 'âš ï¸' : 'ğŸ“…';
    let label = '';
    if (t.dueDate) {
      const [jy,jm,jd] = t.dueDate.split('-').map(Number);
      label += icon + ' ' + jd + ' ' + J.monthNames[jm-1];
    }
    if (t.dueTime) {
      label += (label ? ' Â· ' : 'ğŸ• ') + t.dueTime;
    }
    return '<span style="font-size:11px;color:' + color + ';margin-right:6px">' + label + '</span>';
  }
  
  ['high','mid','low','done'].forEach(grp => {
    const el = document.getElementById('todos-'+grp);
    if (!el) return;
    
    if (!groups[grp].length) {
      el.innerHTML = '<div style="color:var(--text-muted);font-size:13px;padding:8px">â€” Ø®Ø§Ù„ÛŒÙ‡</div>';
      return;
    }
    
    el.innerHTML = groups[grp].map(t => `
      <div class="todo-item ${t.done?'done':''}">
        <div class="priority-dot ${pClasses[t.priority]||'p-low'}"></div>
        <div class="todo-check ${t.done?'checked':''}" onclick="toggleTodo(${t.id})">${t.done?'âœ“':''}</div>
        <div class="todo-text">
          <div>${t.text}</div>
          <div style="margin-top:4px;display:flex;flex-wrap:wrap;gap:4px;align-items:center">
            ${t.tag ? `<span class="tag">${t.tag}</span>` : ''}
            ${dueDateBadge(t)}
          </div>
        </div>
        <button class="delete-btn" onclick="openEditTodo(${t.id})" style="color:var(--text-muted);font-size:14px" title="ÙˆÛŒØ±Ø§ÛŒØ´">âœï¸</button>
        ${t.dueDate ? `<button class="delete-btn" onclick="addTodoToGCal(${t.id})" title="Ø§Ø¶Ø§ÙÙ‡ Ø¨Ù‡ Google Calendar" style="color:var(--blue);font-size:14px">ğŸ“…</button>` : ''}
        <button class="delete-btn" onclick="deleteTodo(${t.id})">âœ•</button>
      </div>
    `).join('');
  });

  renderDashboardTodos();
}

// â”€â”€â”€ GOALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let activeGoalFilter = 'all';

function addGoal(title, deadline, notes, horizon='mid', priority='2') {
  state.goals.push({ id: Date.now(), title, deadline, notes, horizon, priority, progress: 0 });
  save('goals'); renderGoals(); updateStats();
}

function updateGoalProgress(id, val) {
  const g = state.goals.find(g => g.id === id);
  if (g) { g.progress = parseInt(val); save('goals'); renderGoals(); }
}

function deleteGoal(id) {
  state.goals = state.goals.filter(g => g.id !== id);
  save('goals'); renderGoals(); updateStats();
}

function filterGoals(type, btn) {
  activeGoalFilter = type;
  document.querySelectorAll('.goal-filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderGoals();
}

function renderGoals() {
  const list = document.getElementById('goals-list');
  const summaryBox = document.getElementById('goals-summary');
  const summaryContent = document.getElementById('goals-summary-content');
  if (!list) return;

  const horizonLabel = { short:'Ú©ÙˆØªØ§Ù‡â€ŒÙ…Ø¯Øª', mid:'Ù…ÛŒØ§Ù†â€ŒÙ…Ø¯Øª', long:'Ø¨Ù„Ù†Ø¯Ù…Ø¯Øª' };
  const horizonClass = { short:'h-short', mid:'h-mid', long:'h-long' };
  const horizonColor = { short:'#4caf7d', mid:'#c8a96e', long:'#7c6fcd' };
  const priorityLabel = { '1':'ğŸ”´ Ø­ÛŒØ§ØªÛŒ', '2':'ğŸŸ  Ù…Ù‡Ù…', '3':'âšª Ø¹Ø§Ø¯ÛŒ' };
  const priorityClass = { '1':'pf-1', '2':'pf-2', '3':'pf-3' };
  const priorityOrder = { '1':0, '2':1, '3':2 };

  // â”€â”€ Summary â”€â”€
  if (!state.goals.length) {
    summaryBox.style.display = 'none';
  } else {
    summaryBox.style.display = 'block';
    const active = state.goals.filter(g => g.progress < 100);
    const done = state.goals.filter(g => g.progress === 100);
    const avgAll = active.length ? Math.round(active.reduce((s,g) => s+g.progress, 0) / active.length) : 0;

    const groups = [
      { key:'short', label:'Ú©ÙˆØªØ§Ù‡â€ŒÙ…Ø¯Øª', color:'#4caf7d' },
      { key:'mid',   label:'Ù…ÛŒØ§Ù†â€ŒÙ…Ø¯Øª',  color:'#c8a96e' },
      { key:'long',  label:'Ø¨Ù„Ù†Ø¯Ù…Ø¯Øª',   color:'#7c6fcd' },
    ];

    summaryContent.innerHTML = `
      <div style="display:flex;gap:20px;margin-bottom:16px;flex-wrap:wrap">
        <div style="text-align:center">
          <div style="font-size:26px;font-weight:900;color:var(--accent)">${avgAll}%</div>
          <div style="font-size:11px;color:var(--text-muted)">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ù¾ÛŒØ´Ø±ÙØª</div>
        </div>
        <div style="text-align:center">
          <div style="font-size:26px;font-weight:900;color:var(--green)">${done.length}</div>
          <div style="font-size:11px;color:var(--text-muted)">ØªÚ©Ù…ÛŒÙ„â€ŒØ´Ø¯Ù‡</div>
        </div>
        <div style="text-align:center">
          <div style="font-size:26px;font-weight:900;color:var(--blue)">${active.length}</div>
          <div style="font-size:11px;color:var(--text-muted)">Ø¯Ø± Ø¬Ø±ÛŒØ§Ù†</div>
        </div>
      </div>
      ${groups.map(gr => {
        const items = state.goals.filter(g => g.horizon === gr.key);
        if (!items.length) return '';
        const avg = Math.round(items.reduce((s,g) => s+g.progress, 0) / items.length);
        return `
          <div class="summary-row">
            <div style="font-size:12px;font-weight:600;width:80px;color:${gr.color}">${gr.label}</div>
            <div class="summary-bar-wrap">
              <div class="summary-bar-bg">
                <div class="summary-bar-fill" style="width:${avg}%;background:${gr.color}"></div>
              </div>
            </div>
            <div style="font-size:12px;color:var(--text-muted);width:36px;text-align:left">${avg}%</div>
            <div style="font-size:11px;color:var(--text-muted)">${items.length} Ù‡Ø¯Ù</div>
          </div>`;
      }).join('')}
    `;
  }

  // â”€â”€ Filter & Sort â”€â”€
  let filtered = activeGoalFilter === 'all'
    ? [...state.goals]
    : state.goals.filter(g => g.horizon === activeGoalFilter);

  // Sort: priority first, then progress (less progress first)
  filtered.sort((a,b) => {
    const pa = priorityOrder[a.priority||'3'], pb = priorityOrder[b.priority||'3'];
    if (pa !== pb) return pa - pb;
    return (a.progress||0) - (b.progress||0);
  });

  if (!filtered.length) {
    list.innerHTML = '<div class="empty-state"><div class="empty-emoji">ğŸ¯</div>Ù‡Ù†ÙˆØ² Ù‡Ø¯ÙÛŒ ØªØ¹Ø±ÛŒÙ Ù†Ú©Ø±Ø¯ÛŒ</div>';
    return;
  }

  list.innerHTML = filtered.map(g => {
    const h = g.horizon || 'mid';
    const p = g.priority || '2';
    const isDone = g.progress === 100;
    return `
    <div class="card" style="${isDone ? 'opacity:0.6' : ''}">
      <div class="section-header">
        <div style="display:flex;flex-wrap:wrap;align-items:center;gap:8px">
          <div class="goal-title" style="${isDone?'text-decoration:line-through':''}">${g.title}</div>
          <span class="horizon-badge ${horizonClass[h]}">${horizonLabel[h]}</span>
          <span class="priority-flag ${priorityClass[p]}">${priorityLabel[p]}</span>
        </div>
        <div style="display:flex;gap:4px;align-items:center">
          ${g.deadline ? `<button class="delete-btn" onclick="addGoalToGCal(${g.id})" title="Ø§Ø¶Ø§ÙÙ‡ deadline Ø¨Ù‡ Google Calendar" style="color:var(--blue);font-size:14px">ğŸ“…</button>` : ''}
          <button class="delete-btn" onclick="deleteGoal(${g.id})">âœ•</button>
        </div>
      </div>
      ${g.deadline ? `<div class="goal-deadline">ğŸ“… Ù…Ù‡Ù„Øª: ${displayDate(g.deadline)}</div>` : ''}
      ${g.notes ? `<div style="font-size:13px;color:var(--text-muted);margin-bottom:12px">${g.notes}</div>` : ''}
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">
        <div class="progress-bar" style="flex:1">
          <div class="progress-fill" style="width:${g.progress}%;background:linear-gradient(90deg,${horizonColor[h]},${horizonColor[h]}aa)"></div>
        </div>
        <div style="font-size:13px;font-weight:700;color:${horizonColor[h]};min-width:36px">${g.progress}%</div>
      </div>
      ${isDone
        ? `<div style="font-size:13px;color:var(--green);font-weight:600">âœ… ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯!</div>`
        : `<input type="range" min="0" max="100" value="${g.progress}"
            style="width:100%;accent-color:${horizonColor[h]}"
            oninput="updateGoalProgress(${g.id}, this.value)">`
      }
    </div>`;
  }).join('');
}

// â”€â”€â”€ EMOJI PICKER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const EMOJIS = {
  nature:   ['ğŸŒ¸','ğŸŒº','ğŸŒ»','ğŸŒ¹','ğŸŒ·','ğŸŒ¼','ğŸ’','ğŸ€','ğŸŒ¿','ğŸŒ±','ğŸŒ²','ğŸŒ³','ğŸŒ´','ğŸŒµ','ğŸ‹','ğŸ','ğŸƒ','ğŸ‚','ğŸ','ğŸŒ¾','ğŸŒŠ','ğŸŒˆ','â˜€ï¸','ğŸŒ™','â­','ğŸŒŸ','ğŸ’«','âœ¨','ğŸ”¥','â„ï¸','ğŸŒ','ğŸŒ','ğŸŒ•','ğŸŒ ','ğŸ¦‹','ğŸ','ğŸ¦„','ğŸ¬','ğŸ¦','ğŸ¯','ğŸ¦Š','ğŸº','ğŸ¦…','ğŸ¦‹','ğŸ™','ğŸ¦‹'],
  travel:   ['âœˆï¸','ğŸš€','ğŸ›¸','ğŸš‚','ğŸš¢','ğŸš','ğŸ–ï¸','ğŸï¸','ğŸ—ºï¸','ğŸ§­','ğŸ”ï¸','â›°ï¸','ğŸ—»','ğŸ•ï¸','ğŸŒ‹','ğŸœï¸','ğŸŒ…','ğŸŒ„','ğŸŒƒ','ğŸŒ†','ğŸŒ‡','ğŸ™ï¸','ğŸ—¼','ğŸ—½','ğŸ°','ğŸ¯','â›©ï¸','ğŸ•Œ','ğŸ•','ğŸ¡','ğŸ¢','ğŸ ','ğŸª','ğŸ­','ğŸŒ','ğŸŒ','ğŸŒ','ğŸ›«','ğŸ›¬','ğŸš','ğŸšƒ','ğŸš„','ğŸš…','ğŸš‡','ğŸ›³ï¸','â›µ','ğŸš¤'],
  activity: ['âš½','ğŸ€','ğŸˆ','âš¾','ğŸ¾','ğŸ','ğŸ‰','ğŸ±','ğŸ“','ğŸ¸','ğŸ¥Š','ğŸ¥‹','ğŸ¯','ğŸ¹','â›³','ğŸ£','ğŸ¤¿','ğŸ½','ğŸ¿','ğŸ›·','ğŸ¥‡','ğŸ†','ğŸ¥ˆ','ğŸ¥‰','ğŸ–ï¸','ğŸ…','ğŸ—ï¸','ğŸ®','ğŸ•¹ï¸','ğŸ²','ğŸ´','ğŸƒ','ğŸ§©','ğŸ¬','ğŸ¤','ğŸ§','ğŸ¸','ğŸ¹','ğŸº','ğŸ»','ğŸ¥','ğŸ·','ğŸ¨','ğŸ–Œï¸','âœï¸','ğŸ“š','ğŸ“–','ğŸ§˜','ğŸ‹ï¸','ğŸ¤¸','ğŸ§—','ğŸ¤º','ğŸŠ','ğŸš´','ğŸ§œ'],
  food:     ['ğŸ•','ğŸ”','ğŸŒ®','ğŸŒ¯','ğŸœ','ğŸ£','ğŸ±','ğŸ›','ğŸ¥˜','ğŸ²','ğŸ¥—','ğŸ¥™','ğŸ§†','ğŸ¥š','ğŸ³','ğŸ¥','ğŸ§‡','ğŸ¥“','ğŸ¥©','ğŸ—','ğŸ–','ğŸŒ­','ğŸŸ','ğŸ§€','ğŸ¥ª','ğŸ¥¨','ğŸ¥','ğŸ©','ğŸª','ğŸ‚','ğŸ°','ğŸ§','ğŸ«','ğŸ¬','ğŸ­','ğŸ®','ğŸ¯','ğŸ','ğŸŠ','ğŸ‹','ğŸ‡','ğŸ“','ğŸˆ','ğŸ’','ğŸ‘','ğŸ¥­','ğŸ','ğŸ¥','â˜•','ğŸµ','ğŸ§ƒ','ğŸ¥¤','ğŸ§‹','ğŸº','ğŸ·','ğŸ¥‚'],
  work:     ['ğŸ’¼','ğŸ“Š','ğŸ“ˆ','ğŸ“‰','ğŸ’¡','ğŸ”¬','ğŸ”­','ğŸ’»','ğŸ–¥ï¸','âŒ¨ï¸','ğŸ–¨ï¸','ğŸ“±','â˜ï¸','ğŸ“','ğŸ“¡','ğŸ”‹','ğŸ’¾','ğŸ’¿','ğŸ“€','ğŸ–±ï¸','ğŸ–²ï¸','ğŸ“·','ğŸ“¸','ğŸ“¹','ğŸ“º','ğŸ“»','ğŸ™ï¸','ğŸ“ ','ğŸ”‘','ğŸ—ï¸','ğŸ”','ğŸ”’','ğŸ”“','ğŸ”§','ğŸ”¨','âš™ï¸','ğŸ› ï¸','ğŸ§°','ğŸ”©','ğŸ“‹','ğŸ“Œ','ğŸ“','âœ‚ï¸','ğŸ—ƒï¸','ğŸ“‚','ğŸ“','ğŸ—‚ï¸','ğŸ“','âœ’ï¸','ğŸ“','ğŸ“','ğŸ§®','ğŸ’°','ğŸ’³','ğŸ’µ','ğŸ¦','ğŸ“œ','ğŸ›ï¸'],
  people:   ['â¤ï¸','ğŸ§¡','ğŸ’›','ğŸ’š','ğŸ’™','ğŸ’œ','ğŸ–¤','ğŸ¤','ğŸ¤','ğŸ’”','â£ï¸','ğŸ’•','ğŸ’','ğŸ’“','ğŸ’—','ğŸ’–','ğŸ’˜','ğŸ’','ğŸ˜€','ğŸ˜','ğŸ˜‚','ğŸ¤£','ğŸ˜Š','ğŸ˜‡','ğŸ¥°','ğŸ˜','ğŸ¤©','ğŸ˜˜','ğŸ˜—','â˜ºï¸','ğŸ˜‹','ğŸ˜›','ğŸ˜œ','ğŸ¤ª','ğŸ¥³','ğŸ˜','ğŸ¤“','ğŸ§','ğŸ˜','ğŸ˜’','ğŸ˜','ğŸ˜”','ğŸ˜Ÿ','ğŸ˜•','ğŸ™','â˜¹ï¸','ğŸ˜£','ğŸ˜–','ğŸ˜«','ğŸ˜©','ğŸ¥º','ğŸ˜¢','ğŸ˜­','ğŸ˜¤','ğŸ˜ ','ğŸ˜¡','ğŸ¤¯','ğŸ˜³','ğŸ¥µ','ğŸ˜±','ğŸ˜¨','ğŸ˜°','ğŸ˜¶','ğŸ¤','ğŸ˜¬','ğŸ™„','ğŸ˜¯','ğŸ˜§','ğŸ˜¦','ğŸ˜®','ğŸ¤”','ğŸ¤¨','ğŸ˜','ğŸ˜‘'],
  objects:  ['ğŸ','ğŸ€','ğŸŠ','ğŸ‰','ğŸˆ','ğŸ','ğŸ','ğŸ‘','ğŸ§§','ğŸ‹','ğŸ','ğŸ†','ğŸ‡','ğŸ§¨','âœ¨','ğŸƒ','ğŸ„','ğŸ‹','ğŸ®','ğŸª”','ğŸ’','ğŸ‘‘','ğŸ’','ğŸ’„','ğŸ‘—','ğŸ‘˜','ğŸ‘™','ğŸ‘š','ğŸ‘›','ğŸ‘œ','ğŸ‘','ğŸ’','ğŸ§³','ğŸ‘’','ğŸ©','ğŸ§¢','â›‘ï¸','ğŸ“¿','ğŸ’','ğŸ”®','ğŸ§¿','ğŸª¬','ğŸ§²','ğŸ•¯ï¸','ğŸ’¡','ğŸ”¦','ğŸª„','ğŸ´','ğŸ§¸','ğŸª†','ğŸ–¼ï¸','ğŸ§µ','ğŸ§¶','ğŸª¡','ğŸ§·','ğŸª¢','ğŸ“¿','ğŸ”‘','ğŸ—ï¸','ğŸª','ğŸ›‹ï¸','ğŸª‘','ğŸšª','ğŸªŸ','ğŸ›ï¸','ğŸ›','ğŸª´','ğŸº'],
  symbols:  ['â˜®ï¸','âœï¸','â˜ªï¸','ğŸ•‰ï¸','â˜¸ï¸','âœ¡ï¸','ğŸ”¯','ğŸ•','â˜¯ï¸','â˜¦ï¸','ğŸ›','â›','â™ˆ','â™‰','â™Š','â™‹','â™Œ','â™','â™','â™','â™','â™‘','â™’','â™“','ğŸ”€','ğŸ”','ğŸ”‚','â–¶ï¸','â©','â«','â¬','âª','â—€ï¸','ğŸ”¼','ğŸ”½','âï¸','ğŸ”†','ğŸ”…','ğŸ“³','ğŸ“´','ğŸ“µ','ğŸ“¶','ğŸ“³','ğŸ”±','âšœï¸','ğŸ”°','â™»ï¸','âœ…','â','ğŸ”´','ğŸŸ ','ğŸŸ¡','ğŸŸ¢','ğŸ”µ','ğŸŸ£','âš«','âšª','ğŸŸ¤','ğŸ”¶','ğŸ”·','ğŸ”¸','ğŸ”¹','ğŸ”º','ğŸ”»','ğŸ’ ','ğŸ”˜','ğŸ”²','ğŸ”³','â–ªï¸','â–«ï¸','â—¾','â—½','â—¼ï¸','â—»ï¸','ğŸŸ¥','ğŸŸ§','ğŸŸ¨','ğŸŸ©','ğŸŸ¦','ğŸŸª','â¬›','â¬œ','ğŸŸ«','ğŸŒ€','ğŸ’«','â­•','â—','â“','â€¼ï¸','â‰ï¸','ğŸ’¯']
};

let selectedWishEmoji = 'â­';
let activeEmojiCat = 'all';

function toggleEmojiPicker() {
  const p = document.getElementById('emoji-picker');
  const isOpen = p.style.display !== 'none';
  p.style.display = isOpen ? 'none' : 'block';
  if (!isOpen) { renderEmojiGrid(activeEmojiCat); document.getElementById('emoji-search').value=''; }
}

function showEmojiCat(cat, btn) {
  activeEmojiCat = cat;
  document.querySelectorAll('.emoji-cat-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('emoji-search').value = '';
  renderEmojiGrid(cat);
}

function renderEmojiGrid(cat, filter='') {
  const grid = document.getElementById('emoji-grid');
  let list = cat === 'all'
    ? Object.values(EMOJIS).flat()
    : (EMOJIS[cat] || []);
  if (filter) list = Object.values(EMOJIS).flat().filter(e => e.includes(filter));
  // deduplicate
  list = [...new Set(list)];
  grid.innerHTML = list.map(e => `
    <button class="emoji-btn ${e===selectedWishEmoji?'selected':''}" onclick="selectWishEmoji('${e}')">${e}</button>
  `).join('');
}

function selectWishEmoji(emoji) {
  selectedWishEmoji = emoji;
  document.getElementById('wish-emoji-btn').textContent = emoji;
  document.getElementById('emoji-picker').style.display = 'none';
}

function searchEmoji(val) {
  renderEmojiGrid(activeEmojiCat, val);
}

// â”€â”€â”€ WISHES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addWish() {
  const text = document.getElementById('wish-input').value.trim();
  if (!text) return;
  const emoji = selectedWishEmoji || 'â­';
  const cat = document.getElementById('wish-cat').value;
  
  state.wishes.push({ id: Date.now(), text, emoji, cat });
  save('wishes');
  document.getElementById('wish-input').value = '';
  renderWishes();
}

function deleteWish(id) {
  state.wishes = state.wishes.filter(w => w.id !== id);
  save('wishes'); renderWishes();
}

function openEditWish(id) {
  const w = state.wishes.find(w => w.id === id);
  if (!w) return;
  // Store which wish we're editing and set the emoji picker emoji
  selectedWishEmoji = w.emoji;
  const content = document.getElementById('modal-content');
  const cats = ['Ø²Ù†Ø¯Ú¯ÛŒ','Ú©Ø§Ø±','Ø³ÙØ±','Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡','Ù…Ø§Ù„ÛŒ','Ø³Ù„Ø§Ù…Øª','Ø¯ÛŒÚ¯Ø±'];
  content.innerHTML = `
    <div class="modal-title">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ø¢Ø±Ø²Ùˆ</div>
    <div class="form-group">
      <label class="form-label">Ø¢ÛŒÚ©ÙˆÙ†</label>
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
        <button type="button" id="edit-wish-emoji-btn" onclick="toggleEditEmojiPicker()" style="
          font-size:26px;background:var(--surface2);border:1px solid var(--border);
          border-radius:8px;padding:8px 14px;cursor:pointer;min-width:54px">${w.emoji}</button>
        <span style="font-size:12px;color:var(--text-muted)">Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ± Ú©Ù„ÛŒÚ© Ú©Ù†</span>
      </div>
      <div id="edit-emoji-picker" style="display:none">
        <div style="display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap">
          <button class="emoji-cat-btn active" onclick="showEditEmojiCat('all',this)">Ù‡Ù…Ù‡</button>
          <button class="emoji-cat-btn" onclick="showEditEmojiCat('nature',this)">Ø·Ø¨ÛŒØ¹Øª</button>
          <button class="emoji-cat-btn" onclick="showEditEmojiCat('travel',this)">Ø³ÙØ±</button>
          <button class="emoji-cat-btn" onclick="showEditEmojiCat('activity',this)">ÙØ¹Ø§Ù„ÛŒØª</button>
          <button class="emoji-cat-btn" onclick="showEditEmojiCat('food',this)">ØºØ°Ø§</button>
          <button class="emoji-cat-btn" onclick="showEditEmojiCat('work',this)">Ú©Ø§Ø±</button>
          <button class="emoji-cat-btn" onclick="showEditEmojiCat('people',this)">Ø§Ø­Ø³Ø§Ø³Ø§Øª</button>
          <button class="emoji-cat-btn" onclick="showEditEmojiCat('objects',this)">Ø§Ø´ÛŒØ§Ø¡</button>
          <button class="emoji-cat-btn" onclick="showEditEmojiCat('symbols',this)">Ù†Ù…Ø§Ø¯Ù‡Ø§</button>
        </div>
        <input type="text" id="edit-emoji-search" placeholder="ğŸ” Ø¬Ø³ØªØ¬Ùˆ..." oninput="searchEditEmoji(this.value)"
          style="width:100%;margin-bottom:10px;font-size:13px">
        <div id="edit-emoji-grid" style="
          display:grid;grid-template-columns:repeat(auto-fill,minmax(38px,1fr));
          gap:4px;max-height:180px;overflow-y:auto;padding:4px;margin-bottom:12px
        "></div>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Ù…ØªÙ† Ø¢Ø±Ø²Ùˆ *</label>
      <input type="text" id="edit-wish-text" value="${w.text.replace(/"/g,'&quot;')}" style="width:100%">
    </div>
    <div class="form-group">
      <label class="form-label">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</label>
      <select id="edit-wish-cat" style="width:100%">
        ${cats.map(c => `<option value="${c}" ${w.cat===c?'selected':''}>${c}</option>`).join('')}
      </select>
    </div>
    <div style="display:flex;gap:8px;margin-top:4px">
      <button class="btn btn-primary" onclick="saveEditWish(${id})">Ø°Ø®ÛŒØ±Ù‡</button>
      <button class="btn btn-ghost" onclick="closeModal()">Ø§Ù†ØµØ±Ø§Ù</button>
    </div>
  `;
  document.getElementById('modal').classList.add('open');
  renderEditEmojiGrid('all');
}

let activeEditEmojiCat = 'all';

function toggleEditEmojiPicker() {
  const p = document.getElementById('edit-emoji-picker');
  const isOpen = p.style.display !== 'none';
  p.style.display = isOpen ? 'none' : 'block';
  if (!isOpen) { renderEditEmojiGrid(activeEditEmojiCat); document.getElementById('edit-emoji-search').value=''; }
}

function showEditEmojiCat(cat, btn) {
  activeEditEmojiCat = cat;
  document.querySelectorAll('#edit-emoji-picker .emoji-cat-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('edit-emoji-search').value = '';
  renderEditEmojiGrid(cat);
}

function renderEditEmojiGrid(cat, filter='') {
  const grid = document.getElementById('edit-emoji-grid');
  if (!grid) return;
  let list = cat === 'all' ? Object.values(EMOJIS).flat() : (EMOJIS[cat] || []);
  if (filter) list = Object.values(EMOJIS).flat().filter(e => e.includes(filter));
  list = [...new Set(list)];
  grid.innerHTML = list.map(e => `
    <button class="emoji-btn ${e===selectedWishEmoji?'selected':''}" onclick="selectEditEmoji('${e}')">${e}</button>
  `).join('');
}

function searchEditEmoji(val) { renderEditEmojiGrid(activeEditEmojiCat, val); }

function selectEditEmoji(emoji) {
  selectedWishEmoji = emoji;
  const btn = document.getElementById('edit-wish-emoji-btn');
  if (btn) btn.textContent = emoji;
  document.getElementById('edit-emoji-picker').style.display = 'none';
  renderEditEmojiGrid(activeEditEmojiCat);
}

function saveEditWish(id) {
  const w = state.wishes.find(w => w.id === id);
  if (!w) return;
  const text = document.getElementById('edit-wish-text').value.trim();
  if (!text) return;
  w.text = text;
  w.emoji = selectedWishEmoji;
  w.cat = document.getElementById('edit-wish-cat').value;
  save('wishes');
  closeModal();
  renderWishes();
}

function renderWishes() {
  const list = document.getElementById('wishes-list');
  if (!list) return;
  
  if (!state.wishes.length) {
    list.innerHTML = '<div class="empty-state"><div class="empty-emoji">ğŸŒ </div>Ø¢Ø±Ø²ÙˆÙ‡Ø§Øª Ø±Ùˆ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù†ÙˆÛŒØ³</div>';
    return;
  }
  
  list.innerHTML = state.wishes.map(w => `
    <div class="wish-item">
      <span class="wish-emoji">${w.emoji}</span>
      <span class="wish-text">${w.text}</span>
      <span class="wish-cat">${w.cat}</span>
      <button class="delete-btn" onclick="openEditWish(${w.id})" style="font-size:14px" title="ÙˆÛŒØ±Ø§ÛŒØ´">âœï¸</button>
      <button class="delete-btn" onclick="deleteWish(${w.id})">âœ•</button>
    </div>
  `).join('');
}

// â”€â”€â”€ MEETINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addMeeting(title, date, time, with_, notes) {
  state.meetings.push({ id: Date.now(), title, date, time, with: with_, notes });
  state.meetings.sort((a,b) => (a.date+a.time) > (b.date+b.time) ? 1 : -1);
  save('meetings'); renderMeetings();
}

function deleteMeeting(id) {
  state.meetings = state.meetings.filter(m => m.id !== id);
  save('meetings'); renderMeetings();
}

function renderMeetings() {
  const list = document.getElementById('meetings-list');
  if (!list) return;
  
  if (!state.meetings.length) {
    list.innerHTML = '<div class="empty-state"><div class="empty-emoji">ğŸ“…</div>Ø¬Ù„Ø³Ù‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</div>';
    return;
  }
  
  const today = todayStr();
  const upcoming = state.meetings.filter(m => J.compareKeys(m.date, today) >= 0);
  const past = state.meetings.filter(m => J.compareKeys(m.date, today) < 0);
  
  const renderGroup = (arr, label) => arr.length ? `
    <div class="card-title" style="padding:0 0 12px">${label}</div>
    ${arr.map(m => `
      <div class="meeting-item">
        <div class="section-header" style="margin:0">
          <div class="meeting-title">${m.title}</div>
          <div style="display:flex;gap:4px">
            <button class="delete-btn" onclick="addMeetingToGCal(${m.id})" title="Ø§Ø¶Ø§ÙÙ‡ Ø¨Ù‡ Google Calendar" style="color:var(--blue);font-size:14px">ğŸ“…</button>
            <button class="delete-btn" onclick="deleteMeeting(${m.id})">âœ•</button>
          </div>
        </div>
        <div class="meeting-meta">
          ğŸ“… ${displayDate(m.date)} ${m.time ? 'â€¢ â° '+m.time : ''}
          ${m.with ? 'â€¢ ğŸ‘¤ '+m.with : ''}
        </div>
        ${m.notes ? `<div style="font-size:13px;color:var(--text-muted);margin-top:6px">${m.notes}</div>` : ''}
      </div>
    `).join('')}
  ` : '';
  
  list.innerHTML = `<div class="card">${renderGroup(upcoming,'ğŸ“Œ Ù¾ÛŒØ´â€ŒØ±Ùˆ')}${renderGroup(past,'â® Ú¯Ø°Ø´ØªÙ‡')}</div>`;
  
  // Dashboard
  const dash = document.getElementById('dashboard-meetings');
  if (dash) {
    if (!upcoming.length) dash.innerHTML = '<div class="empty-state" style="padding:20px"><div class="empty-emoji">ğŸ—“</div>Ø¬Ù„Ø³Ù‡â€ŒØ§ÛŒ Ø¯Ø± ØµÙ Ù†Ø¯Ø§Ø±ÛŒ</div>';
    else dash.innerHTML = upcoming.slice(0,3).map(m => `
      <div class="meeting-item">
        <div class="meeting-title">${m.title}</div>
        <div class="meeting-meta">ğŸ“… ${displayDate(m.date)} ${m.time ? 'â€¢ â° '+m.time : ''}</div>
      </div>
    `).join('');
  }
}

// â”€â”€â”€ STATS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateStats() {
  document.getElementById('stat-todos').textContent = state.todos.filter(t => !t.done).length;
  document.getElementById('stat-goals').textContent = state.goals.filter(g => g.progress < 100).length;

  // 7-day mood average
  const moodScore = { 'ğŸ˜': 5, 'ğŸ™‚': 4, 'ğŸ˜': 3, 'ğŸ˜”': 2, 'ğŸ˜¤': 2, 'ğŸ˜°': 1 };
  const moodLabel = { 5: 'Ø¹Ø§Ù„ÛŒ', 4: 'Ø®ÙˆØ¨', 3: 'Ù…Ø¹Ù…ÙˆÙ„ÛŒ', 2: 'Ø¨Ø¯', 1: 'Ø®ÛŒÙ„ÛŒ Ø¨Ø¯' };

  // Get last 7 days as jalali keys
  const last7 = [];
  for (let i = 0; i < 7; i++) {
    const d = new Date();
    d.setDate(d.getDate() - i);
    last7.push(J.gDateToKey(d));
  }

  const entries = state.journal.filter(j => last7.includes(j.date) && j.mood && moodScore[j.mood]);
  const el = document.getElementById('stat-journal');
  const labelEl = document.getElementById('stat-journal-label');

  if (!entries.length) {
    el.textContent = 'â€”';
    labelEl.textContent = 'Ø­Ø§Ù„ Ù‡ÙØªÙ‡ (Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡)';
    return;
  }

  const avg = entries.reduce((s, j) => s + moodScore[j.mood], 0) / entries.length;
  const rounded = Math.round(avg);
  // Pick dominant mood emoji
  const counts = {};
  entries.forEach(j => counts[j.mood] = (counts[j.mood]||0) + 1);
  const dominantMood = Object.entries(counts).sort((a,b) => b[1]-a[1])[0][0];

  el.textContent = dominantMood;
  labelEl.textContent = `Ø­Ø§Ù„ Ù‡ÙØªÙ‡: ${moodLabel[rounded] || 'Ù…Ø¹Ù…ÙˆÙ„ÛŒ'} (${entries.length}/7 Ø±ÙˆØ²)`;
}

// â”€â”€â”€ DATE PICKER (3-mode: day / month / year) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var pickerTarget = null;
var pickerYear, pickerMonth;
var pickerView = 'day';

function openPicker(inputId) {
  pickerTarget = inputId;
  var today = J.todayJ();
  var val = document.getElementById(inputId).value;
  if (val && val.indexOf('/') >= 0) {
    var parts = val.split('/');
    pickerYear = parseInt(parts[0]); pickerMonth = parseInt(parts[1]);
  } else {
    pickerYear = today[0]; pickerMonth = today[1];
  }
  pickerView = 'day';
  renderPicker();
  document.getElementById('date-picker-overlay').style.display = 'flex';
}

function closePicker() {
  document.getElementById('date-picker-overlay').style.display = 'none';
}

function renderPicker() {
  var el = document.getElementById('date-picker-content');
  if (pickerView === 'day')   el.innerHTML = buildDayView();
  if (pickerView === 'month') el.innerHTML = buildMonthView();
  if (pickerView === 'year')  el.innerHTML = buildYearView();
}

var PICKER_WRAP = 'background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:20px;width:310px;direction:rtl;font-family:Vazirmatn,sans-serif';

function pNavBtn(fn, label) {
  return '<button onclick="' + fn + '" style="background:none;border:none;color:var(--text);font-size:20px;cursor:pointer;padding:4px 10px;border-radius:6px">' + label + '</button>';
}

function pTitleBtn(fn, label) {
  return '<button onclick="' + fn + '" style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:6px 14px;color:var(--accent);font-size:14px;font-weight:700;cursor:pointer;font-family:Vazirmatn,sans-serif">' + label + '</button>';
}

function buildDayView() {
  var tod = J.todayJ(); var ty=tod[0], tm=tod[1], td=tod[2];
  var daysInMonth = [0,31,31,31,31,31,31,30,30,30,30,30,29];
  var g1 = J.toGregorian(pickerYear, pickerMonth, 1);
  var dow1 = new Date(g1[0], g1[1]-1, g1[2]).getDay();
  // RTL grid: slot0 Ø¯Ø± Ø±Ø§Ø³Øª = Ø´Ù†Ø¨Ù‡ØŒ slot6 Ø¯Ø± Ú†Ù¾ = Ø¬Ù…Ø¹Ù‡
  // Sat=6â†’0, Sun=0â†’1, Mon=1â†’2, Tue=2â†’3, Wed=3â†’4, Thu=4â†’5, Fri=5â†’6
  var colMap = {6:0, 0:1, 1:2, 2:3, 3:4, 4:5, 5:6};
  var satOffset = colMap[dow1];
  var total = daysInMonth[pickerMonth];

  var h = '<div style="background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:20px;width:310px;font-family:Vazirmatn,sans-serif;direction:rtl">';
  h += '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;gap:6px">';
  h += pNavBtn('pickerNavMonth(-1)', 'â€¹');
  h += '<div style="display:flex;gap:6px">';
  h += pTitleBtn("pickerView='month';renderPicker()", J.monthNames[pickerMonth-1]);
  h += pTitleBtn("pickerView='year';renderPicker()", String(pickerYear));
  h += '</div>';
  h += pNavBtn('pickerNavMonth(1)', 'â€º');
  h += '</div>';

  // header RTL: Ø¯Ø± DOM [Ø´,ÛŒ,Ø¯,Ø³,Ú†,Ù¾,Ø¬] â†’ Ù†Ù…Ø§ÛŒØ´ RTL: Ø¬ Ù¾ Ú† Ø³ Ø¯ ÛŒ Ø´ âœ“
  h += '<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:3px;margin-bottom:4px">';
  var sn = ['Ø´Ù†Ø¨Ù‡','ÛŒÚ©Ø´Ù†Ø¨Ù‡','Ø¯ÙˆØ´Ù†Ø¨Ù‡','Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡','Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡','Ù¾Ù†Ø¬Ø´Ù†Ø¨Ù‡','Ø¬Ù…Ø¹Ù‡'];
  for (var i=0; i<7; i++) {
    var isF = (i===6);
    h += '<div style="text-align:center;font-size:9px;color:' + (isF?'#7c6fcd':'var(--text-muted)') + ';padding:5px 1px;letter-spacing:-0.3px">' + sn[i] + '</div>';
  }
  h += '</div>';

  // grid RTL: slot0=Ø±Ø§Ø³Øª=Ø´Ù†Ø¨Ù‡ØŒ offset Ø®Ø§Ù†Ù‡ Ø®Ø§Ù„ÛŒ Ø§Ø² Ø±Ø§Ø³ØªØŒ Ø±ÙˆØ²Ù‡Ø§ Ù¾Ø± Ù…ÛŒØ´Ù†
  h += '<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:3px">';
  for (var i=0; i<satOffset; i++) h += '<div></div>';
  for (var d=1; d<=total; d++) {
    var slot = satOffset + d - 1;
    var col  = slot % 7;
    var isFri = (col === 6);
    var isT  = (pickerYear===ty && pickerMonth===tm && d===td);
    var bg = isT ? 'rgba(200,169,110,0.2)' : 'var(--surface2)';
    var bc = isT ? 'var(--accent)' : 'transparent';
    var co = isT ? 'var(--accent)' : (isFri ? '#7c6fcd' : 'var(--text)');
    h += '<button onclick="pickerSelect(' + d + ')" style="background:' + bg + ';border:1px solid ' + bc + ';border-radius:6px;padding:7px 2px;color:' + co + ';font-size:13px;cursor:pointer;font-family:Vazirmatn,sans-serif;transition:background 0.15s" onmouseover="this.style.background=\'rgba(200,169,110,0.2)\'" onmouseout="this.style.background=\'' + bg + '\'">' + d + '</button>';
  }
  h += '</div>';

  h += '<div style="margin-top:12px;display:flex;justify-content:space-between">';
  h += '<button onclick="pickerGoToday()" style="background:none;border:none;color:var(--accent);font-size:12px;cursor:pointer;font-family:Vazirmatn,sans-serif">Ø§Ù…Ø±ÙˆØ²</button>';
  h += '<button onclick="closePicker()" style="background:none;border:none;color:var(--text-muted);font-size:12px;cursor:pointer;font-family:Vazirmatn,sans-serif">Ø§Ù†ØµØ±Ø§Ù</button>';
  h += '</div></div>';
  return h;
}

function buildMonthView() {
  var h = '<div style="' + PICKER_WRAP + '">';
  h += '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">';
  h += pNavBtn('pickerYear--;renderPicker()', 'â€¹');
  h += pTitleBtn('pickerView=\'year\';renderPicker()', String(pickerYear));
  h += pNavBtn('pickerYear++;renderPicker()', 'â€º');
  h += '</div>';
  h += '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">';
  for (var i=0; i<12; i++) {
    var isCur = (i+1) === pickerMonth;
    var bg = isCur ? 'rgba(200,169,110,0.2)' : 'var(--surface2)';
    var bc = isCur ? 'var(--accent)' : 'var(--border)';
    var co = isCur ? 'var(--accent)' : 'var(--text)';
    var fw = isCur ? '700' : '400';
    h += '<button onclick="pickerMonth=' + (i+1) + ';pickerView=\'day\';renderPicker()" style="background:' + bg + ';border:1px solid ' + bc + ';border-radius:8px;padding:10px 4px;color:' + co + ';font-size:13px;cursor:pointer;font-family:Vazirmatn,sans-serif;font-weight:' + fw + '">' + J.monthNames[i] + '</button>';
  }
  h += '</div>';
  h += '<div style="margin-top:14px;text-align:center"><button onclick="closePicker()" style="background:none;border:none;color:var(--text-muted);font-size:12px;cursor:pointer;font-family:Vazirmatn,sans-serif">Ø§Ù†ØµØ±Ø§Ù</button></div>';
  h += '</div>';
  return h;
}

function buildYearView() {
  var ty = J.todayJ()[0];
  var start = Math.floor((pickerYear - 1) / 12) * 12 + 1;
  var h = '<div style="' + PICKER_WRAP + '">';
  h += '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">';
  h += pNavBtn('pickerYearNav(-12)', 'â€¹');
  h += '<div style="font-size:13px;color:var(--text-muted)">' + start + ' â€“ ' + (start+11) + '</div>';
  h += pNavBtn('pickerYearNav(12)', 'â€º');
  h += '</div>';
  h += '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">';
  for (var i=0; i<12; i++) {
    var y = start + i;
    var isCur = y === pickerYear, isThisY = y === ty;
    var bg = isCur ? 'rgba(200,169,110,0.2)' : 'var(--surface2)';
    var bc = isCur ? 'var(--accent)' : (isThisY ? 'rgba(200,169,110,0.4)' : 'var(--border)');
    var co = (isCur || isThisY) ? 'var(--accent)' : 'var(--text)';
    var fw = isCur ? '700' : '400';
    h += '<button onclick="pickerYear=' + y + ';pickerView=\'month\';renderPicker()" style="background:' + bg + ';border:1px solid ' + bc + ';border-radius:8px;padding:10px 4px;color:' + co + ';font-size:13px;cursor:pointer;font-family:Vazirmatn,sans-serif;font-weight:' + fw + '">' + y + '</button>';
  }
  h += '</div>';
  h += '<div style="margin-top:14px;text-align:center"><button onclick="closePicker()" style="background:none;border:none;color:var(--text-muted);font-size:12px;cursor:pointer;font-family:Vazirmatn,sans-serif">Ø§Ù†ØµØ±Ø§Ù</button></div>';
  h += '</div>';
  return h;
}

function pickerNavMonth(dir) {
  pickerMonth += dir;
  if (pickerMonth > 12) { pickerMonth = 1; pickerYear++; }
  if (pickerMonth < 1)  { pickerMonth = 12; pickerYear--; }
  renderPicker();
}

function pickerYearNav(dir) { pickerYear += dir; renderPicker(); }

function pickerGoToday() {
  var t = J.todayJ();
  pickerYear = t[0]; pickerMonth = t[1];
  pickerSelect(t[2]);
}

function pickerSelect(day) {
  var m = String(pickerMonth).padStart(2,'0');
  var d = String(day).padStart(2,'0');
  if (pickerTarget) document.getElementById(pickerTarget).value = pickerYear + '/' + m + '/' + d;
  closePicker();
}

// â”€â”€â”€ TIME PICKER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var timePickerTarget = null;
var tpHour = 12, tpMinute = 0;
var tpMode = 'hour'; // 'hour' | 'minute'

function openTimePicker(inputId) {
  timePickerTarget = inputId;
  var val = document.getElementById(inputId).value;
  if (val && val.indexOf(':') >= 0) {
    var parts = val.split(':');
    tpHour = parseInt(parts[0]) || 12;
    tpMinute = parseInt(parts[1]) || 0;
  } else {
    tpHour = 12; tpMinute = 0;
  }
  tpMode = 'hour';
  renderTimePicker();
  document.getElementById('time-picker-overlay').style.display = 'flex';
}

function closeTimePicker() {
  document.getElementById('time-picker-overlay').style.display = 'none';
}

function renderTimePicker() {
  document.getElementById('time-picker-content').innerHTML = buildTimePicker();
  drawClock();
}

function buildTimePicker() {
  var hStr = String(tpHour).padStart(2,'0');
  var mStr = String(tpMinute).padStart(2,'0');
  var hActive = tpMode==='hour' ? 'color:var(--accent);border-color:var(--accent);' : 'color:var(--text-muted);border-color:transparent;';
  var mActive = tpMode==='minute' ? 'color:var(--accent);border-color:var(--accent);' : 'color:var(--text-muted);border-color:transparent;';

  return '<div style="background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:24px;width:300px;direction:rtl;font-family:Vazirmatn,sans-serif">'
    + '<div style="text-align:center;margin-bottom:16px">'
    + '<span onclick="tpMode=\'hour\';renderTimePicker()" style="font-size:42px;font-weight:900;cursor:pointer;border-bottom:2px solid;padding:0 4px;transition:all 0.2s;' + hActive + '">' + hStr + '</span>'
    + '<span style="font-size:42px;font-weight:900;color:var(--text-muted);padding:0 2px">:</span>'
    + '<span onclick="tpMode=\'minute\';renderTimePicker()" style="font-size:42px;font-weight:900;cursor:pointer;border-bottom:2px solid;padding:0 4px;transition:all 0.2s;' + mActive + '">' + mStr + '</span>'
    + '<div style="font-size:11px;color:var(--text-muted);margin-top:6px">' + (tpMode==='hour' ? 'Ø³Ø§Ø¹Øª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯' : 'Ø¯Ù‚ÛŒÙ‚Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯') + '</div>'
    + '</div>'
    + '<div style="display:flex;justify-content:center;margin-bottom:20px">'
    + '<canvas id="tp-canvas" width="240" height="240" style="cursor:pointer;border-radius:50%;width:240px;height:240px"></canvas>'
    + '</div>'
    + '<div style="display:flex;justify-content:space-between;align-items:center">'
    + '<button onclick="closeTimePicker()" style="background:none;border:none;color:var(--text-muted);font-size:13px;cursor:pointer;font-family:Vazirmatn,sans-serif">Ø§Ù†ØµØ±Ø§Ù</button>'
    + '<button onclick="confirmTime()" style="background:var(--accent);border:none;border-radius:8px;padding:8px 20px;color:#0d0d0f;font-size:13px;font-weight:700;cursor:pointer;font-family:Vazirmatn,sans-serif">ØªØ£ÛŒÛŒØ¯</button>'
    + '</div>'
    + '</div>';
}

function drawClock() {
  var canvas = document.getElementById('tp-canvas');
  if (!canvas) return;
  var ctx = canvas.getContext('2d');
  var W = 240, cx = 120, cy = 120;
  canvas.width = W; canvas.height = W;

  ctx.clearRect(0,0,W,W);

  // Background
  ctx.beginPath();
  ctx.arc(cx,cy,115,0,2*Math.PI);
  ctx.fillStyle = '#1a1a22';
  ctx.fill();
  ctx.strokeStyle = '#2a2a35';
  ctx.lineWidth = 1.5;
  ctx.stroke();

  if (tpMode === 'hour') {
    var RO = 90;  // outer ring radius (1-12)
    var RI = 62;  // inner ring radius (13-24/00)

    // Draw outer ring: 1-12 (standard clock positions)
    for (var i = 1; i <= 12; i++) {
      var angle = (i/12)*2*Math.PI - Math.PI/2;
      var x = cx + Math.cos(angle)*RO;
      var y = cy + Math.sin(angle)*RO;
      var isSel = i === tpHour || (i === 12 && tpHour === 12);
      var selOuter = tpHour >= 1 && tpHour <= 12 && tpHour === i;

      ctx.beginPath();
      ctx.arc(x, y, 16, 0, 2*Math.PI);
      ctx.fillStyle = selOuter ? '#c8a96e' : 'rgba(255,255,255,0.06)';
      ctx.fill();

      ctx.font = (selOuter ? 'bold ' : '') + '13px sans-serif';
      ctx.fillStyle = selOuter ? '#0d0d0f' : '#e8e8f0';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(String(i), x, y);
    }

    // Draw inner ring: 13-23 + 00 (positions of 1-12 but inner)
    for (var i = 0; i <= 11; i++) {
      var hour24 = i === 0 ? 0 : i + 12; // 13,14,...,23,00
      var pos = (i === 0) ? 12 : i; // clock position
      var angle = (pos/12)*2*Math.PI - Math.PI/2;
      var x = cx + Math.cos(angle)*RI;
      var y = cy + Math.sin(angle)*RI;
      var selInner = tpHour === hour24;

      ctx.beginPath();
      ctx.arc(x, y, 13, 0, 2*Math.PI);
      ctx.fillStyle = selInner ? '#c8a96e' : 'rgba(255,255,255,0.04)';
      ctx.fill();

      ctx.font = (selInner ? 'bold ' : '') + '11px sans-serif';
      ctx.fillStyle = selInner ? '#0d0d0f' : '#7a7a90';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(hour24 === 0 ? '00' : String(hour24), x, y);
    }

    // Hand to selected
    var selPos, selR;
    if (tpHour >= 1 && tpHour <= 12) {
      selPos = tpHour; selR = RO;
    } else {
      // inner: 0â†’pos12, 13â†’pos1, 14â†’pos2, ...
      selPos = tpHour === 0 ? 12 : tpHour - 12;
      selR = RI;
    }
    var handAngle = (selPos/12)*2*Math.PI - Math.PI/2;
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.lineTo(cx + Math.cos(handAngle)*selR, cy + Math.sin(handAngle)*selR);
    ctx.strokeStyle = '#c8a96e';
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.stroke();

  } else {
    // â”€â”€ MINUTE MODE â”€â”€
    var RM = 90;
    for (var i = 0; i < 60; i++) {
      var angle = (i/60)*2*Math.PI - Math.PI/2;
      var x = cx + Math.cos(angle)*RM;
      var y = cy + Math.sin(angle)*RM;
      var isMajor = i % 5 === 0;
      var isSel = i === tpMinute;

      if (isSel) {
        ctx.beginPath();
        ctx.arc(x, y, 16, 0, 2*Math.PI);
        ctx.fillStyle = '#c8a96e';
        ctx.fill();
        ctx.font = 'bold 12px sans-serif';
        ctx.fillStyle = '#0d0d0f';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(String(i).padStart(2,'0'), x, y);
      } else if (isMajor) {
        ctx.beginPath();
        ctx.arc(x, y, 14, 0, 2*Math.PI);
        ctx.fillStyle = 'rgba(255,255,255,0.06)';
        ctx.fill();
        ctx.font = '12px sans-serif';
        ctx.fillStyle = '#c8c8d8';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(String(i).padStart(2,'0'), x, y);
      } else {
        ctx.beginPath();
        ctx.arc(x, y, 2.5, 0, 2*Math.PI);
        ctx.fillStyle = 'rgba(255,255,255,0.18)';
        ctx.fill();
      }
    }
    // Hand
    var mAngle = (tpMinute/60)*2*Math.PI - Math.PI/2;
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.lineTo(cx + Math.cos(mAngle)*RM, cy + Math.sin(mAngle)*RM);
    ctx.strokeStyle = '#c8a96e';
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.stroke();
  }

  // Center dot
  ctx.beginPath();
  ctx.arc(cx, cy, 5, 0, 2*Math.PI);
  ctx.fillStyle = '#c8a96e';
  ctx.fill();

  // â”€â”€ CLICK: find nearest number â”€â”€
  canvas.onclick = function(e) {
    var rect = canvas.getBoundingClientRect();
    var scaleX = W / rect.width;
    var scaleY = W / rect.height;
    var mx = (e.clientX - rect.left) * scaleX - cx;
    var my = (e.clientY - rect.top)  * scaleY - cy;

    if (tpMode === 'hour') {
      var dist = Math.sqrt(mx*mx + my*my);
      var angle = Math.atan2(my, mx) + Math.PI/2;
      if (angle < 0) angle += 2*Math.PI;

      // Find nearest among all 24 hour positions
      var best = -1, bestDist = 9999;
      // Outer 1-12
      for (var i=1; i<=12; i++) {
        var a = (i/12)*2*Math.PI - Math.PI/2;
        var hx = Math.cos(a)*90, hy = Math.sin(a)*90;
        var d = Math.sqrt((mx-hx)*(mx-hx)+(my-hy)*(my-hy));
        if (d < bestDist) { bestDist=d; best=i; }
      }
      // Inner 0,13-23
      for (var i=0; i<=11; i++) {
        var hour24 = i===0 ? 0 : i+12;
        var pos = i===0 ? 12 : i;
        var a = (pos/12)*2*Math.PI - Math.PI/2;
        var hx = Math.cos(a)*62, hy = Math.sin(a)*62;
        var d = Math.sqrt((mx-hx)*(mx-hx)+(my-hy)*(my-hy));
        if (d < bestDist) { bestDist=d; best=hour24; }
      }
      tpHour = best;
      tpMode = 'minute';
      renderTimePicker();

    } else {
      // Minute: find nearest among 60 positions
      var best = 0, bestDist = 9999;
      for (var i=0; i<60; i++) {
        var a = (i/60)*2*Math.PI - Math.PI/2;
        var hx = Math.cos(a)*90, hy = Math.sin(a)*90;
        var d = Math.sqrt((mx-hx)*(mx-hx)+(my-hy)*(my-hy));
        if (d < bestDist) { bestDist=d; best=i; }
      }
      tpMinute = best;
      renderTimePicker();
    }
  };
}

function confirmTime() {
  var val = String(tpHour).padStart(2,'0') + ':' + String(tpMinute).padStart(2,'0');
  if (timePickerTarget) document.getElementById(timePickerTarget).value = val;
  closeTimePicker();
}

// â”€â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(type) {
  const modal = document.getElementById('modal');
  const content = document.getElementById('modal-content');
  
  if (type === 'goal') {
    content.innerHTML = `
      <div class="modal-title">ğŸ¯ Ù‡Ø¯Ù Ø¬Ø¯ÛŒØ¯</div>
      <div class="form-group">
        <label class="form-label">Ø¹Ù†ÙˆØ§Ù† Ù‡Ø¯Ù *</label>
        <input type="text" id="m-goal-title" placeholder="Ù…Ø«Ù„Ø§Ù‹: ÛŒØ§Ø¯ Ú¯Ø±ÙØªÙ† Ù¾Ø§ÛŒØªÙˆÙ†" style="width:100%">
      </div>
      <div class="grid-2" style="gap:10px;margin-bottom:14px">
        <div>
          <label class="form-label">Ø§ÙÙ‚ Ø²Ù…Ø§Ù†ÛŒ</label>
          <select id="m-goal-horizon" style="width:100%">
            <option value="short">ğŸŸ¢ Ú©ÙˆØªØ§Ù‡â€ŒÙ…Ø¯Øª (ØªØ§ Û³ Ù…Ø§Ù‡)</option>
            <option value="mid" selected>ğŸŸ¡ Ù…ÛŒØ§Ù†â€ŒÙ…Ø¯Øª (Û³ ØªØ§ Û±Û² Ù…Ø§Ù‡)</option>
            <option value="long">ğŸŸ£ Ø¨Ù„Ù†Ø¯Ù…Ø¯Øª (Ø¨ÛŒØ´ Ø§Ø² Û± Ø³Ø§Ù„)</option>
          </select>
        </div>
        <div>
          <label class="form-label">Ø§ÙˆÙ„ÙˆÛŒØª</label>
          <select id="m-goal-priority" style="width:100%">
            <option value="1">ğŸ”´ Ø­ÛŒØ§ØªÛŒ</option>
            <option value="2" selected>ğŸŸ  Ù…Ù‡Ù…</option>
            <option value="3">âšª Ø¹Ø§Ø¯ÛŒ</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Ù…Ù‡Ù„Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
        <div style="display:flex;gap:8px">
          <input type="text" id="m-goal-deadline" placeholder="Ù…Ø«Ù„Ø§Ù‹: Û±Û´Û°Û´/Û°Û¶/Û³Û±" style="flex:1" readonly>
          <button type="button" class="btn btn-ghost" onclick="openPicker('m-goal-deadline')" style="padding:10px 14px">ğŸ“…</button>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</label>
        <textarea id="m-goal-notes" placeholder="Ú†Ø±Ø§ Ù…Ù‡Ù…Ù‡ØŸ Ú†Ø·ÙˆØ± Ù‚Ø±Ø§Ø±Ù‡ Ø¨Ù‡Ø´ Ø¨Ø±Ø³ÛŒØŸ" style="min-height:80px"></textarea>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-primary" onclick="submitGoal()">Ø°Ø®ÛŒØ±Ù‡</button>
        <button class="btn btn-ghost" onclick="closeModal()">Ø§Ù†ØµØ±Ø§Ù</button>
      </div>
    `;
  } else if (type === 'meeting') {
    content.innerHTML = `
      <div class="modal-title">ğŸ“… Ø¬Ù„Ø³Ù‡ Ø¬Ø¯ÛŒØ¯</div>
      <div class="form-group">
        <label class="form-label">Ù…ÙˆØ¶ÙˆØ¹ Ø¬Ù„Ø³Ù‡ *</label>
        <input type="text" id="m-meet-title" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø¬Ù„Ø³Ù‡ ØªÛŒÙ… Ù…Ø­ØµÙˆÙ„" style="width:100%">
      </div>
      <div class="grid-2" style="gap:10px;margin-bottom:14px">
        <div>
          <label class="form-label">ØªØ§Ø±ÛŒØ® *</label>
          <div style="display:flex;gap:6px">
            <input type="text" id="m-meet-date" placeholder="ØªØ§Ø±ÛŒØ®" style="flex:1" readonly>
            <button type="button" class="btn btn-ghost" onclick="openPicker('m-meet-date')" style="padding:10px 12px">ğŸ“…</button>
          </div>
        </div>
        <div>
          <label class="form-label">Ø³Ø§Ø¹Øª</label>
          <div style="display:flex;gap:6px">
            <input type="text" id="m-meet-time" placeholder="--:--" readonly style="flex:1;cursor:pointer" onclick="openTimePicker('m-meet-time')">
            <button type="button" class="btn btn-ghost" onclick="openTimePicker('m-meet-time')" style="padding:10px 12px">ğŸ•</button>
            <button type="button" class="btn btn-ghost" onclick="document.getElementById('m-meet-time').value=''" style="padding:10px 12px;color:var(--red)">âœ•</button>
          </div>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Ø¨Ø§ Ú†Ù‡ Ú©Ø³ÛŒØŸ</label>
        <input type="text" id="m-meet-with" placeholder="Ø§Ø³Ù… ÛŒØ§ ØªÛŒÙ…" style="width:100%">
      </div>
      <div class="form-group">
        <label class="form-label">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</label>
        <textarea id="m-meet-notes" placeholder="Ø¢Ø¬Ù†Ø¯Ø§ØŒ Ù†Ú©Ø§Øª Ù…Ù‡Ù…..." style="min-height:80px"></textarea>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-primary" onclick="submitMeeting()">Ø°Ø®ÛŒØ±Ù‡</button>
        <button class="btn btn-ghost" onclick="closeModal()">Ø§Ù†ØµØ±Ø§Ù</button>
      </div>
    `;
  }
  
  modal.classList.add('open');
}

function closeModal() {
  document.getElementById('modal').classList.remove('open');
}

function submitGoal() {
  const title = document.getElementById('m-goal-title').value.trim();
  if (!title) return;
  const deadlineRaw = document.getElementById('m-goal-deadline').value.trim();
  const deadlineKey = deadlineRaw ? deadlineRaw.replace(/\//g,'-') : '';
  const horizon = document.getElementById('m-goal-horizon').value;
  const priority = document.getElementById('m-goal-priority').value;
  addGoal(title, deadlineKey, document.getElementById('m-goal-notes').value, horizon, priority);
  closeModal();
}

function submitMeeting() {
  const title = document.getElementById('m-meet-title').value.trim();
  const dateRaw = document.getElementById('m-meet-date').value.trim();
  if (!title || !dateRaw) return;
  const dateKey = dateRaw.replace(/\//g,'-');
  addMeeting(title, dateKey, document.getElementById('m-meet-time').value, document.getElementById('m-meet-with').value, document.getElementById('m-meet-notes').value);
  closeModal();
}

document.getElementById('modal').addEventListener('click', e => {
  if (e.target === document.getElementById('modal')) closeModal();
});

// â”€â”€â”€ GOOGLE CALENDAR EXPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Convert jalali key (YYYY-MM-DD) + optional time (HH:MM) to Google Calendar date strings
function jalaliKeyToGCal(key, time) {
  const [jy,jm,jd] = key.split('-').map(Number);
  const [gy,gm,gd] = J.toGregorian(jy,jm,jd);
  const pad = n => String(n).padStart(2,'0');
  if (time) {
    const [h,mi] = time.split(':').map(Number);
    // Format: YYYYMMDDTHHmmss
    const start = `${gy}${pad(gm)}${pad(gd)}T${pad(h)}${pad(mi)}00`;
    // Default 1 hour duration
    const endH = h + 1;
    const end = `${gy}${pad(gm)}${pad(gd)}T${pad(endH < 24 ? endH : 23)}${pad(mi)}00`;
    return { dates: `${start}/${end}` };
  } else {
    // All-day: YYYYMMDD/YYYYMMDD (same day)
    const dateStr = `${gy}${pad(gm)}${pad(gd)}`;
    // next day for end
    const endDate = new Date(gy, gm-1, gd+1);
    const endStr = `${endDate.getFullYear()}${pad(endDate.getMonth()+1)}${pad(endDate.getDate())}`;
    return { dates: `${dateStr}/${endStr}` };
  }
}

function openInGCal(title, key, time, details='', location='') {
  try {
    const { dates } = jalaliKeyToGCal(key, time);
    const params = new URLSearchParams({
      action: 'TEMPLATE',
      text: title,
      dates: dates,
      details: details,
      location: location
    });
    window.open('https://calendar.google.com/calendar/render?' + params.toString(), '_blank');
  } catch(e) {
    alert('ØªØ§Ø±ÛŒØ® Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª!');
  }
}

function addMeetingToGCal(id) {
  const m = state.meetings.find(m => m.id === id);
  if (!m) return;
  const details = [m.notes, m.with ? 'Ø¨Ø§: ' + m.with : ''].filter(Boolean).join('\n');
  openInGCal(m.title, m.date, m.time, details);
}

function addTodoToGCal(id) {
  const t = state.todos.find(t => t.id === id);
  if (!t || !t.dueDate) { alert('Ø§ÛŒÙ† Ú©Ø§Ø± ØªØ§Ø±ÛŒØ® Ø³Ø±Ø±Ø³ÛŒØ¯ Ù†Ø¯Ø§Ø±Ù‡!'); return; }
  const details = t.tag ? 'Ø¨Ø±Ú†Ø³Ø¨: ' + t.tag : '';
  openInGCal('âœ… ' + t.text, t.dueDate, t.dueTime, details);
}

function addGoalToGCal(id) {
  const g = state.goals.find(g => g.id === id);
  if (!g || !g.deadline) { alert('Ø§ÛŒÙ† Ù‡Ø¯Ù deadline Ù†Ø¯Ø§Ø±Ù‡!'); return; }
  const details = g.notes || '';
  openInGCal('ğŸ¯ ' + g.title, g.deadline, '', details);
}

// â”€â”€â”€ SUPABASE SYNC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let SUPABASE_URL = localStorage.getItem('sb_url') || '';
let SUPABASE_KEY = localStorage.getItem('sb_key') || '';
let syncStatus = 'idle'; // idle | syncing | ok | error

function isSBConfigured() { return SUPABASE_URL && SUPABASE_KEY; }

async function sbRequest(method, path, body) {
  const headers = {
    'apikey': SUPABASE_KEY,
    'Authorization': 'Bearer ' + SUPABASE_KEY,
    'Content-Type': 'application/json'
  };
  if (method === 'POST') headers['Prefer'] = 'resolution=merge-duplicates,return=minimal';
  const res = await fetch(SUPABASE_URL + '/rest/v1/' + path, {
    method, headers,
    body: body ? JSON.stringify(body) : undefined
  });
  if (!res.ok) { const t = await res.text(); throw new Error(t || res.status); }
  const txt = await res.text();
  if (!txt || !txt.trim()) return null;
  return JSON.parse(txt);
}

async function syncToCloud() {
  if (!isSBConfigured()) { openSBSettings(); return; }
  setSyncStatus('syncing');
  try {
    const payload = {
      id: 'default',
      todos: JSON.stringify(state.todos),
      goals: JSON.stringify(state.goals),
      wishes: JSON.stringify(state.wishes),
      meetings: JSON.stringify(state.meetings),
      journal: JSON.stringify(state.journal),
      ideas: JSON.stringify(state.ideas),
      updated_at: new Date().toISOString()
    };
    await sbRequest('POST', 'brain_data', payload);
    setSyncStatus('ok');
  } catch(e) {
    console.error('Sync error:', e);
    setSyncStatus('error');
  }
}

async function syncFromCloud() {
  if (!isSBConfigured()) { openSBSettings(); return; }
  setSyncStatus('syncing');
  try {
    const data = await sbRequest('GET', 'brain_data?id=eq.default&select=*');
    if (!data || !data.length) {
      setSyncStatus('error');
      alert('Ù‡ÛŒÚ† Ø¯ÛŒØªØ§ÛŒÛŒ Ø¯Ø± cloud Ù†ÛŒØ³Øª. Ø§ÙˆÙ„ ÛŒÙ‡ Ø¨Ø§Ø± Ø¢Ù¾Ù„ÙˆØ¯ Ú©Ù†.');
      return;
    }
    const row = data[0];
    ['todos','goals','wishes','meetings','journal','ideas'].forEach(k => {
      try { state[k] = JSON.parse(row[k]) || []; } catch(e) { state[k] = []; }
      save(k);
    });
    renderAll();
    setSyncStatus('ok');
    showToast('âœ… Ø¯ÛŒØªØ§ Ø§Ø² cloud Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯!');
  } catch(e) {
    console.error('Fetch error:', e);
    setSyncStatus('error');
    alert('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯ÛŒØªØ§: ' + e.message);
  }
}

function setSyncStatus(s) {
  syncStatus = s;
  const btn = document.getElementById('sync-btn');
  const badge = document.getElementById('sync-badge');
  if (!btn || !badge) return;
  if (s === 'syncing') {
    badge.textContent = 'â³';
    badge.style.color = 'var(--accent)';
    btn.disabled = true;
  } else if (s === 'ok') {
    badge.textContent = 'â˜ï¸';
    badge.style.color = 'var(--green)';
    btn.disabled = false;
    showToast('âœ… Ø¢Ù¾Ù„ÙˆØ¯ Ù…ÙˆÙÙ‚!');
  } else if (s === 'error') {
    badge.textContent = 'âš ï¸';
    badge.style.color = 'var(--red)';
    btn.disabled = false;
  } else {
    badge.textContent = isSBConfigured() ? 'â˜ï¸' : 'âš™ï¸';
    badge.style.color = isSBConfigured() ? 'var(--text-muted)' : 'var(--accent)';
    btn.disabled = false;
  }
}

function showToast(msg) {
  const t = document.getElementById('toast');
  if (!t) return;
  t.textContent = msg;
  t.style.opacity = '1';
  t.style.transform = 'translateY(0)';
  setTimeout(() => {
    t.style.opacity = '0';
    t.style.transform = 'translateY(20px)';
  }, 2500);
}

function openSBSettings() {
  const content = document.getElementById('modal-content');
  content.innerHTML = `
    <div class="modal-title">â˜ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Supabase</div>
    <div style="background:rgba(124,111,205,0.08);border:1px solid rgba(124,111,205,0.3);border-radius:10px;padding:14px;margin-bottom:18px;font-size:13px;line-height:1.8;color:var(--text-muted)">
      <div style="font-weight:700;color:var(--accent2);margin-bottom:6px">ğŸ“‹ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø³Ø±ÛŒØ¹:</div>
      <div>Û±. Ø¨Ù‡ <a href="https://supabase.com" target="_blank" style="color:var(--accent)">supabase.com</a> Ø¨Ø±Ùˆ Ùˆ Ø§Ú©Ø§Ù†Øª Ø¨Ø³Ø§Ø²</div>
      <div>Û². ÛŒÙ‡ project Ø¬Ø¯ÛŒØ¯ Ø¨Ø³Ø§Ø² (Ø±Ø§ÛŒÚ¯Ø§Ù†Ù‡)</div>
      <div>Û³. Ø§Ø² Ù…Ù†ÙˆÛŒ <b>Project Settings â†’ API</b> Ø¢Ø¯Ø±Ø³ Ùˆ Ú©Ù„ÛŒØ¯ Ø±Ùˆ Ú©Ù¾ÛŒ Ú©Ù†</div>
      <div>Û´. ØªÙˆÛŒ <b>SQL Editor</b> Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± Ø±Ùˆ Ø§Ø¬Ø±Ø§ Ú©Ù†:</div>
      <div style="background:var(--surface2);border-radius:6px;padding:10px;margin-top:8px;font-family:monospace;font-size:11px;color:var(--text);direction:ltr;text-align:left;white-space:pre-wrap">CREATE TABLE brain_data (
  id TEXT PRIMARY KEY,
  todos TEXT, goals TEXT,
  wishes TEXT, meetings TEXT,
  journal TEXT,
  updated_at TIMESTAMPTZ
);</div>
    </div>
    <div class="form-group">
      <label class="form-label">Project URL</label>
      <input type="text" id="sb-url-input" value="${SUPABASE_URL}" placeholder="https://xxxxxxxxxxxx.supabase.co" style="width:100%;direction:ltr;font-size:13px">
    </div>
    <div class="form-group">
      <label class="form-label">anon public key</label>
      <input type="text" id="sb-key-input" value="${SUPABASE_KEY}" placeholder="eyJhbGciOiJI..." style="width:100%;direction:ltr;font-size:13px">
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn btn-primary" onclick="saveSBSettings()">Ø°Ø®ÛŒØ±Ù‡ Ùˆ ØªØ³Øª</button>
      <button class="btn btn-ghost" onclick="closeModal()">Ø§Ù†ØµØ±Ø§Ù</button>
      ${isSBConfigured() ? '<button class="btn btn-ghost" style="color:var(--red)" onclick="clearSBSettings()">Ø­Ø°Ù ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button>' : ''}
    </div>
  `;
  document.getElementById('modal').classList.add('open');
}

async function saveSBSettings() {
  const url = document.getElementById('sb-url-input').value.trim().replace(/\/$/, '');
  const key = document.getElementById('sb-key-input').value.trim();
  if (!url || !key) { alert('Ù‡Ø± Ø¯Ùˆ ÙÛŒÙ„Ø¯ Ø±Ùˆ Ù¾Ø± Ú©Ù†!'); return; }
  SUPABASE_URL = url;
  SUPABASE_KEY = key;
  localStorage.setItem('sb_url', url);
  localStorage.setItem('sb_key', key);
  closeModal();
  setSyncStatus('idle');
  showToast('âš™ï¸ Ø¯Ø± Ø­Ø§Ù„ ØªØ³Øª Ø§ØªØµØ§Ù„...');
  // test connection
  try {
    await sbRequest('GET', 'brain_data?limit=1');
    showToast('âœ… Ø§ØªØµØ§Ù„ Ø¨Ø±Ù‚Ø±Ø§Ø± Ø´Ø¯!');
    setSyncStatus('idle');
  } catch(e) {
    showToast('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ â€” ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø±Ùˆ Ú†Ú© Ú©Ù†');
    setSyncStatus('error');
  }
}

function clearSBSettings() {
  SUPABASE_URL = ''; SUPABASE_KEY = '';
  localStorage.removeItem('sb_url'); localStorage.removeItem('sb_key');
  closeModal(); setSyncStatus('idle');
}

// â”€â”€â”€ IDEAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let selectedIdeaColor = '#c8a96e';
let ideaFilter = 'all';
let ideaCatFilter = '';

function selectIdeaColor(color, btn) {
  selectedIdeaColor = color;
  document.querySelectorAll('#idea-color-picker .idea-color-swatch').forEach(b => b.style.border = '2px solid transparent');
  btn.style.border = '2px solid white';
}

function setIdeaFilter(f, btn) {
  ideaFilter = f;
  ideaCatFilter = '';
  document.querySelectorAll('.idea-filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderIdeas();
}

function setIdeaFilterCat(cat, btn) {
  ideaFilter = 'all';
  ideaCatFilter = (ideaCatFilter === cat) ? '' : cat;
  document.querySelectorAll('.idea-filter-btn').forEach(b => b.classList.remove('active'));
  if (ideaCatFilter) btn.classList.add('active');
  else document.querySelector('.idea-filter-btn[data-filter="all"]').classList.add('active');
  renderIdeas();
}

function saveNewIdea() {
  const title = document.getElementById('idea-title-input').value.trim();
  if (!title) return;
  const desc = document.getElementById('idea-desc-input').value.trim();
  const cat = document.getElementById('idea-cat-select').value;
  const priority = document.getElementById('idea-priority-select').value;
  const tagsRaw = document.getElementById('idea-tags-input').value.trim();
  const tags = tagsRaw ? tagsRaw.split(',').map(t => t.trim()).filter(Boolean) : [];
  
  const idea = {
    id: Date.now(),
    title,
    desc,
    cat,
    priority,
    tags,
    color: selectedIdeaColor,
    status: 'new', // new | wip | done
    pinned: false
  };
  
  state.ideas.unshift(idea);
  save('ideas');
  document.getElementById('idea-title-input').value = '';
  document.getElementById('idea-desc-input').value = '';
  document.getElementById('idea-tags-input').value = '';
  renderIdeas();
  updateStats();
}

function toggleIdeaPin(id) {
  const idea = state.ideas.find(i => i.id === id);
  if (idea) { idea.pinned = !idea.pinned; save('ideas'); renderIdeas(); }
}

function cycleIdeaStatus(id) {
  const idea = state.ideas.find(i => i.id === id);
  if (!idea) return;
  const cycle = { 'new': 'wip', 'wip': 'done', 'done': 'new' };
  idea.status = cycle[idea.status] || 'new';
  save('ideas'); renderIdeas(); updateStats();
}

function deleteIdea(id) {
  state.ideas = state.ideas.filter(i => i.id !== id);
  save('ideas'); renderIdeas(); updateStats();
}

function openEditIdea(id) {
  const idea = state.ideas.find(i => i.id === id);
  if (!idea) return;
  selectedIdeaColor = idea.color || '#c8a96e';
  const cats = ['Ú©Ø§Ø±','Ø´Ø®ØµÛŒ','Ù¾Ø±ÙˆÚ˜Ù‡','Ù…Ø­ØµÙˆÙ„','Ø¢Ù…ÙˆØ²Ø´','Ø¯ÛŒÚ¯Ø±'];
  const catEmojis = { 'Ú©Ø§Ø±':'ğŸ’¼','Ø´Ø®ØµÛŒ':'ğŸ™‹','Ù¾Ø±ÙˆÚ˜Ù‡':'ğŸš€','Ù…Ø­ØµÙˆÙ„':'ğŸ“¦','Ø¢Ù…ÙˆØ²Ø´':'ğŸ“š','Ø¯ÛŒÚ¯Ø±':'ğŸ’¬' };
  const colors = ['#c8a96e','#5b9cf6','#4caf7d','#e05555','#7c6fcd','#888'];
  
  const content = document.getElementById('modal-content');
  content.innerHTML = `
    <div class="modal-title">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ø§ÛŒØ¯Ù‡</div>
    <div class="form-group">
      <label class="form-label">Ø¹Ù†ÙˆØ§Ù† *</label>
      <input type="text" id="edit-idea-title" value="${idea.title.replace(/"/g,'&quot;')}" style="width:100%">
    </div>
    <div class="form-group">
      <label class="form-label">ØªÙˆØ¶ÛŒØ­Ø§Øª</label>
      <textarea id="edit-idea-desc" style="min-height:80px;width:100%">${idea.desc||''}</textarea>
    </div>
    <div class="grid-2" style="gap:10px;margin-bottom:14px">
      <div>
        <label class="form-label">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</label>
        <select id="edit-idea-cat" style="width:100%">
          ${cats.map(c => `<option value="${c}" ${idea.cat===c?'selected':''}>${catEmojis[c]} ${c}</option>`).join('')}
        </select>
      </div>
      <div>
        <label class="form-label">Ø§ÙˆÙ„ÙˆÛŒØª</label>
        <select id="edit-idea-priority" style="width:100%">
          <option value="high" ${idea.priority==='high'?'selected':''}>ğŸ”´ Ù…Ù‡Ù…</option>
          <option value="mid" ${idea.priority==='mid'?'selected':''}>ğŸŸ¡ Ù…Ø¹Ù…ÙˆÙ„ÛŒ</option>
          <option value="low" ${idea.priority==='low'?'selected':''}>âšª Ø¹Ø§Ø¯ÛŒ</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§ (Ø¨Ø§ ÙˆÛŒØ±Ú¯ÙˆÙ„ Ø¬Ø¯Ø§ Ú©Ù†)</label>
      <input type="text" id="edit-idea-tags" value="${(idea.tags||[]).join(', ')}" style="width:100%" placeholder="Ù…Ø«Ù„Ø§Ù‹: React, Ù…Ù‡Ù…, Ù‡ÙØªÙ‡ Ø¢ÛŒÙ†Ø¯Ù‡">
    </div>
    <div class="form-group">
      <label class="form-label">Ø±Ù†Ú¯</label>
      <div style="display:flex;gap:8px;align-items:center">
        ${colors.map(c => `<button class="idea-color-swatch" data-color="${c}" onclick="selectIdeaColor('${c}',this);document.querySelectorAll('#modal .idea-color-swatch').forEach(b=>b.style.border='2px solid transparent');this.style.border='2px solid white'" style="width:24px;height:24px;border-radius:50%;background:${c};border:${c===selectedIdeaColor?'2px solid white':'2px solid transparent'};cursor:pointer"></button>`).join('')}
      </div>
    </div>
    <div style="display:flex;gap:8px;margin-top:4px">
      <button class="btn btn-primary" onclick="saveEditIdea(${id})">Ø°Ø®ÛŒØ±Ù‡</button>
      <button class="btn btn-ghost" onclick="closeModal()">Ø§Ù†ØµØ±Ø§Ù</button>
    </div>
  `;
  document.getElementById('modal').classList.add('open');
}

function saveEditIdea(id) {
  const idea = state.ideas.find(i => i.id === id);
  if (!idea) return;
  const title = document.getElementById('edit-idea-title').value.trim();
  if (!title) return;
  idea.title = title;
  idea.desc = document.getElementById('edit-idea-desc').value.trim();
  idea.cat = document.getElementById('edit-idea-cat').value;
  idea.priority = document.getElementById('edit-idea-priority').value;
  const tagsRaw = document.getElementById('edit-idea-tags').value.trim();
  idea.tags = tagsRaw ? tagsRaw.split(',').map(t => t.trim()).filter(Boolean) : [];
  idea.color = selectedIdeaColor;
  save('ideas');
  closeModal();
  renderIdeas();
}

function renderIdeas() {
  const list = document.getElementById('ideas-list');
  if (!list) return;

  // Stats
  const statsRow = document.getElementById('ideas-stats-row');
  if (statsRow) {
    const all = state.ideas;
    const newC = all.filter(i => i.status === 'new').length;
    const wipC = all.filter(i => i.status === 'wip').length;
    const doneC = all.filter(i => i.status === 'done').length;
    const pinnedC = all.filter(i => i.pinned).length;
    statsRow.innerHTML = [
      { num: all.length,   label: 'Ú©Ù„ Ø§ÛŒØ¯Ù‡â€ŒÙ‡Ø§',      color: 'var(--text)' },
      { num: newC,         label: 'ğŸ†• Ø¨Ø±Ø±Ø³ÛŒ Ù†Ø´Ø¯Ù‡',   color: '#5b9cf6' },
      { num: wipC,         label: 'âš™ï¸ Ø¯Ø± Ø¬Ø±ÛŒØ§Ù†',      color: 'var(--accent)' },
      { num: doneC,        label: 'âœ… Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯',       color: '#4caf7d' },
    ].map(s => `
      <div class="stat-box" style="padding:12px">
        <div class="stat-num" style="font-size:24px;color:${s.color}">${s.num}</div>
        <div class="stat-label">${s.label}</div>
      </div>
    `).join('');
  }

  const search = (document.getElementById('idea-search')?.value || '').trim().toLowerCase();
  const statusLabels = { new: 'Ø¨Ø±Ø±Ø³ÛŒ Ù†Ø´Ø¯Ù‡', wip: 'Ø¯Ø± Ø¬Ø±ÛŒØ§Ù†', done: 'Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯' };
  const statusClasses = { new: 'is-new', wip: 'is-wip', done: 'is-done' };
  const priorityIcon = { high: 'ğŸ”´', mid: 'ğŸŸ¡', low: 'âšª' };
  const catEmoji = { 'Ú©Ø§Ø±':'ğŸ’¼','Ø´Ø®ØµÛŒ':'ğŸ™‹','Ù¾Ø±ÙˆÚ˜Ù‡':'ğŸš€','Ù…Ø­ØµÙˆÙ„':'ğŸ“¦','Ø¢Ù…ÙˆØ²Ø´':'ğŸ“š','Ø¯ÛŒÚ¯Ø±':'ğŸ’¬' };

  let items = [...state.ideas];

  // Filter by status/priority
  if (ideaFilter === 'pinned') items = items.filter(i => i.pinned);
  else if (ideaFilter === 'new') items = items.filter(i => i.status === 'new');
  else if (ideaFilter === 'wip') items = items.filter(i => i.status === 'wip');
  else if (ideaFilter === 'done') items = items.filter(i => i.status === 'done');
  else if (ideaFilter === 'high') items = items.filter(i => i.priority === 'high');

  // Filter by category
  if (ideaCatFilter) items = items.filter(i => i.cat === ideaCatFilter);

  // Search
  if (search) {
    items = items.filter(i =>
      i.title.toLowerCase().includes(search) ||
      (i.desc||'').toLowerCase().includes(search) ||
      (i.tags||[]).some(t => t.toLowerCase().includes(search)) ||
      i.cat.toLowerCase().includes(search)
    );
  }

  // Sort: pinned first, then by priority, then id (newest)
  const prioOrder = { high: 0, mid: 1, low: 2 };
  items.sort((a, b) => {
    if (a.pinned !== b.pinned) return a.pinned ? -1 : 1;
    if ((prioOrder[a.priority]||1) !== (prioOrder[b.priority]||1)) return (prioOrder[a.priority]||1) - (prioOrder[b.priority]||1);
    return b.id - a.id;
  });

  if (!items.length) {
    list.innerHTML = '<div class="empty-state"><div class="empty-emoji">ğŸ’¡</div>Ø§ÛŒØ¯Ù‡â€ŒØ§ÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯</div>';
    return;
  }

  list.innerHTML = items.map(idea => {
    const color = idea.color || '#c8a96e';
    const tagsHtml = (idea.tags||[]).map(t =>
      `<span class="idea-tag" onclick="document.getElementById('idea-search').value='${t}';renderIdeas()">${t}</span>`
    ).join('');
    
    return `
      <div class="idea-card ${idea.pinned ? 'pinned' : ''}" style="border-right: 3px solid ${color}">
        <div style="display:flex;align-items:flex-start;gap:10px">
          <div style="flex:1;min-width:0">
            <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:6px">
              <span style="font-size:15px;font-weight:700;color:var(--text)">${idea.title}</span>
              ${idea.pinned ? '<span style="font-size:13px">ğŸ“Œ</span>' : ''}
            </div>
            <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;margin-bottom:${idea.desc?'8px':'0'}">
              <span class="idea-status-badge ${statusClasses[idea.status]||'is-new'}">${statusLabels[idea.status]||'Ø¨Ø±Ø±Ø³ÛŒ Ù†Ø´Ø¯Ù‡'}</span>
              <span style="font-size:12px;color:var(--text-muted)">${catEmoji[idea.cat]||''} ${idea.cat}</span>
              <span style="font-size:12px">${priorityIcon[idea.priority]||'ğŸŸ¡'}</span>
              ${tagsHtml}
            </div>
            ${idea.desc ? `<div class="idea-desc">${idea.desc.replace(/</g,'&lt;')}</div>` : ''}
          </div>
          <div style="display:flex;flex-direction:column;gap:4px;flex-shrink:0">
            <button onclick="toggleIdeaPin(${idea.id})" title="${idea.pinned?'Ø¨Ø±Ø¯Ø§Ø´ØªÙ† Ù¾ÛŒÙ†':'Ù¾ÛŒÙ† Ú©Ø±Ø¯Ù†'}" style="background:none;border:none;cursor:pointer;font-size:15px;padding:3px;opacity:${idea.pinned?1:0.4};transition:opacity 0.2s" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity='${idea.pinned?1:0.4}'">ğŸ“Œ</button>
            <button onclick="cycleIdeaStatus(${idea.id})" title="ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª" class="delete-btn" style="font-size:14px">ğŸ”„</button>
            <button onclick="openEditIdea(${idea.id})" title="ÙˆÛŒØ±Ø§ÛŒØ´" class="delete-btn" style="font-size:14px">âœï¸</button>
            <button onclick="deleteIdea(${idea.id})" class="delete-btn">âœ•</button>
          </div>
        </div>
      </div>
    `;
  }).join('');
}


// â”€â”€â”€ CALENDAR MONTH/YEAR QUICK PICKER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let calPickerView = 'month'; // 'month' | 'year'
let calPickerTempYear = 0;

function openCalMonthPicker() {
  calPickerTempYear = calYear;
  calPickerView = 'month';
  renderCalPicker();
  const ov = document.getElementById('cal-picker-overlay');
  ov.style.display = 'flex';
}

function closeCalPicker() {
  document.getElementById('cal-picker-overlay').style.display = 'none';
}

function renderCalPicker() {
  const el = document.getElementById('cal-picker-content');
  if (!el) return;
  if (calPickerView === 'month') el.innerHTML = buildCalMonthPicker();
  else el.innerHTML = buildCalYearPicker();
}

function buildCalMonthPicker() {
  let h = `<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px">
    <button onclick="calPickerTempYear--;renderCalPicker()" style="background:none;border:1px solid var(--border);border-radius:8px;color:var(--text);cursor:pointer;padding:6px 12px;font-size:16px">â€¹</button>
    <button onclick="calPickerView='year';renderCalPicker()" style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--accent);font-size:16px;font-weight:800;cursor:pointer;padding:6px 16px;font-family:Vazirmatn,sans-serif">${calPickerTempYear}</button>
    <button onclick="calPickerTempYear++;renderCalPicker()" style="background:none;border:1px solid var(--border);border-radius:8px;color:var(--text);cursor:pointer;padding:6px 12px;font-size:16px">â€º</button>
  </div>
  <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">`;

  for (let i = 0; i < 12; i++) {
    const isCur = (calPickerTempYear === calYear && i+1 === calMonth);
    const bg  = isCur ? 'rgba(200,169,110,0.2)' : 'var(--surface2)';
    const bc  = isCur ? 'var(--accent)' : 'var(--border)';
    const col = isCur ? 'var(--accent)' : 'var(--text)';
    const fw  = isCur ? '700' : '400';
    h += `<button onclick="calYear=${calPickerTempYear};calMonth=${i+1};calSelectedKey=null;closeCalPicker();renderCalendar()" style="background:${bg};border:1px solid ${bc};border-radius:8px;padding:10px 4px;color:${col};font-size:13px;cursor:pointer;font-family:Vazirmatn,sans-serif;font-weight:${fw};transition:all 0.15s" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='${bc}'">${J.monthNames[i]}</button>`;
  }

  h += `</div>
  <div style="margin-top:14px;text-align:center">
    <button onclick="closeCalPicker()" style="background:none;border:none;color:var(--text-muted);font-size:13px;cursor:pointer;font-family:Vazirmatn,sans-serif">Ø§Ù†ØµØ±Ø§Ù</button>
  </div>`;
  return h;
}

function buildCalYearPicker() {
  const todayYear = J.todayJ()[0];
  const start = Math.floor((calPickerTempYear - 1) / 12) * 12 + 1;
  let h = `<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px">
    <button onclick="calPickerTempYear-=12;renderCalPicker()" style="background:none;border:1px solid var(--border);border-radius:8px;color:var(--text);cursor:pointer;padding:6px 12px;font-size:16px">â€¹</button>
    <span style="font-size:13px;color:var(--text-muted)">${start} â€“ ${start+11}</span>
    <button onclick="calPickerTempYear+=12;renderCalPicker()" style="background:none;border:1px solid var(--border);border-radius:8px;color:var(--text);cursor:pointer;padding:6px 12px;font-size:16px">â€º</button>
  </div>
  <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">`;

  for (let i = 0; i < 12; i++) {
    const y = start + i;
    const isCur = y === calYear;
    const isThis = y === todayYear;
    const bg  = isCur ? 'rgba(200,169,110,0.2)' : 'var(--surface2)';
    const bc  = isCur ? 'var(--accent)' : (isThis ? 'rgba(200,169,110,0.4)' : 'var(--border)');
    const col = (isCur || isThis) ? 'var(--accent)' : 'var(--text)';
    const fw  = isCur ? '700' : '400';
    h += `<button onclick="calPickerTempYear=${y};calPickerView='month';renderCalPicker()" style="background:${bg};border:1px solid ${bc};border-radius:8px;padding:10px 4px;color:${col};font-size:13px;cursor:pointer;font-family:Vazirmatn,sans-serif;font-weight:${fw};transition:all 0.15s">${y}</button>`;
  }

  h += `</div>
  <div style="margin-top:14px;display:flex;justify-content:space-between">
    <button onclick="calPickerView='month';renderCalPicker()" style="background:none;border:none;color:var(--accent);font-size:12px;cursor:pointer;font-family:Vazirmatn,sans-serif">â† Ø¨Ø±Ú¯Ø´Øª</button>
    <button onclick="closeCalPicker()" style="background:none;border:none;color:var(--text-muted);font-size:13px;cursor:pointer;font-family:Vazirmatn,sans-serif">Ø§Ù†ØµØ±Ø§Ù</button>
  </div>`;
  return h;
}

document.addEventListener('click', e => {
  const ov = document.getElementById('cal-picker-overlay');
  if (ov && e.target === ov) closeCalPicker();
});


let calYear = 0, calMonth = 0, calSelectedKey = null;

function calInit() {
  const [jy, jm] = J.todayJ();
  calYear = jy; calMonth = jm;
  calSelectedKey = J.todayKey();
}

function calNav(dir) {
  calMonth += dir;
  if (calMonth > 12) { calMonth = 1; calYear++; }
  if (calMonth < 1)  { calMonth = 12; calYear--; }
  renderCalendar();
}

function calGoToday() {
  const [jy, jm] = J.todayJ();
  calYear = jy; calMonth = jm;
  calSelectedKey = J.todayKey();
  renderCalendar();
}

function calSelectDay(key) {
  calSelectedKey = key;
  renderCalendar();
  setTimeout(() => {
    const panel = document.getElementById('cal-detail-panel');
    if (panel) panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }, 50);
}

function renderCalendar() {
  if (!calYear) calInit();

  const titleEl = document.getElementById('cal-month-title');
  if (titleEl) titleEl.innerHTML = J.monthNames[calMonth-1] + ' <span>' + calYear + '</span>';

  const todayKey = J.todayKey();
  const daysInMonth = [0,31,31,31,31,31,31,30,30,30,30,30,29][calMonth];

  const [gy1, gm1, gd1] = J.toGregorian(calYear, calMonth, 1);
  const gDate1 = new Date(gy1, gm1-1, gd1);
  const dow1 = gDate1.getDay();
  const colMap = {6:0, 0:1, 1:2, 2:3, 3:4, 4:5, 5:6};
  const startCol = colMap[dow1];

  const prevMonthDaysArr = [0,31,31,31,31,31,31,30,30,30,30,30,29];
  const prevMonth = calMonth === 1 ? 12 : calMonth - 1;
  const prevYear  = calMonth === 1 ? calYear - 1 : calYear;
  const prevDays  = prevMonthDaysArr[prevMonth];
  const nextMonth = calMonth === 12 ? 1 : calMonth + 1;
  const nextYear  = calMonth === 12 ? calYear + 1 : calYear;

  function makeKey(y, m, d) {
    return y + '-' + String(m).padStart(2,'0') + '-' + String(d).padStart(2,'0');
  }

  function getEvents(key) {
    return {
      todos:    state.todos.filter(t => t.dueDate === key),
      goals:    state.goals.filter(g => g.deadline === key),
      meetings: state.meetings.filter(m => m.date === key),
      journals: state.journal.filter(j => j.date === key),
    };
  }

  const grid = document.getElementById('cal-grid');
  if (!grid) return;

  const totalSlots = Math.ceil((startCol + daysInMonth) / 7) * 7;
  let html = '';

  for (let slot = 0; slot < totalSlots; slot++) {
    const col = slot % 7;
    const isFriday = col === 6;
    let dayNum, key, isCurrentMonth = true;

    if (slot < startCol) {
      dayNum = prevDays - startCol + slot + 1;
      key = makeKey(prevYear, prevMonth, dayNum);
      isCurrentMonth = false;
    } else if (slot < startCol + daysInMonth) {
      dayNum = slot - startCol + 1;
      key = makeKey(calYear, calMonth, dayNum);
    } else {
      dayNum = slot - startCol - daysInMonth + 1;
      key = makeKey(nextYear, nextMonth, dayNum);
      isCurrentMonth = false;
    }

    const isToday    = key === todayKey;
    const isSelected = key === calSelectedKey;
    const ev = getEvents(key);

    let cls = 'cal-cell';
    if (!isCurrentMonth) cls += ' other-month';
    if (isToday)         cls += ' today';
    if (isSelected)      cls += ' selected';
    if (isFriday)        cls += ' friday-cell';

    // Build chips
    const chips = [];
    ev.meetings.forEach(m => chips.push({ label: 'ğŸ“… ' + m.title, cls: 'chip-meet' }));
    ev.goals.forEach(g => chips.push({ label: 'ğŸ¯ ' + g.title, cls: 'chip-goal' }));
    ev.todos.filter(t => t.priority === 'high' && !t.done).slice(0,1).forEach(t => chips.push({ label: 'ğŸ”´ ' + t.text, cls: 'chip-todo' }));
    if (ev.journals.length) chips.push({ label: 'ğŸ“ Ú˜ÙˆØ±Ù†Ø§Ù„' + (ev.journals[0].mood ? ' ' + ev.journals[0].mood : ''), cls: 'chip-journal' });

    const visible = chips.slice(0, 2);
    const extra   = chips.length - visible.length;
    let chipsHtml = visible.map(c => `<span class="cal-event-chip ${c.cls}">${c.label}</span>`).join('');
    if (extra > 0) chipsHtml += `<span style="font-size:10px;color:var(--text-muted);margin-top:2px;display:block">+${extra} Ø¯ÛŒÚ¯Ù‡</span>`;

    // Simple dots when no named chips
    let dotsHtml = '';
    if (!chips.length) {
      const dotColors = [];
      if (ev.todos.filter(t=>!t.done).length)  dotColors.push('#e05555');
      if (ev.goals.length)    dotColors.push('#7c6fcd');
      if (ev.meetings.length) dotColors.push('#5b9cf6');
      if (ev.journals.length) dotColors.push('#4caf7d');
      if (dotColors.length) dotsHtml = `<div class="cal-dot-row">${dotColors.map(c=>`<div class="cal-dot" style="background:${c}"></div>`).join('')}</div>`;
    }

    const dayNumHtml = isToday
      ? `<div class="cal-today-ring">${dayNum}</div>`
      : `<div style="font-size:13px;font-weight:${isSelected?'800':'600'};color:${isFriday?'#7c6fcd':(isSelected?'var(--accent)':'var(--text)')}">${dayNum}</div>`;

    html += `<div class="${cls}" onclick="calSelectDay('${key}')">
      <div class="cal-day-num">${dayNumHtml}</div>
      ${chipsHtml}${dotsHtml}
    </div>`;
  }

  grid.innerHTML = html;
  renderCalDetail(calSelectedKey);
}

function renderCalDetail(key) {
  const panel = document.getElementById('cal-detail-panel');
  if (!panel || !key) return;

  const [jy, jm, jd] = key.split('-').map(Number);
  const [gy, gm, gd] = J.toGregorian(jy, jm, jd);
  const gDate = new Date(gy, gm-1, gd);
  const dowName = J.weekDayNames[(gDate.getDay()+1)%7];
  const isToday = key === J.todayKey();

  const todos    = state.todos.filter(t => t.dueDate === key);
  const goals    = state.goals.filter(g => g.deadline === key);
  const meetings = state.meetings.filter(m => m.date === key);
  const journals = state.journal.filter(j => j.date === key);
  const totalEvents = todos.length + goals.length + meetings.length + journals.length;

  const todayBadge = isToday
    ? `<span style="font-size:11px;background:rgba(200,169,110,0.2);border:1px solid var(--accent);border-radius:99px;padding:2px 10px">Ø§Ù…Ø±ÙˆØ²</span>`
    : '';

  if (!totalEvents) {
    panel.innerHTML = `<div class="cal-detail">
      <div class="cal-detail-title">${dowName}ØŒ ${jd} ${J.monthNames[jm-1]} ${jy} ${todayBadge}</div>
      <div style="color:var(--text-muted);font-size:13px;text-align:center;padding:16px 0">Ù‡ÛŒÚ† Ø±ÙˆÛŒØ¯Ø§Ø¯ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø±ÙˆØ² Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ âœ¨</div>
    </div>`;
    return;
  }

  function section(icon, color, title, items, renderFn) {
    if (!items.length) return '';
    return `<div class="cal-detail-section">
      <div class="cal-detail-section-title"><span style="color:${color}">${icon}</span> ${title} <span style="color:var(--border)">(${items.length})</span></div>
      ${items.map(renderFn).join('')}
    </div>`;
  }

  const pIcon = { high:'ğŸ”´', mid:'ğŸŸ¡', low:'âšª' };
  const hLabel = { short:'Ú©ÙˆØªØ§Ù‡â€ŒÙ…Ø¯Øª', mid:'Ù…ÛŒØ§Ù†â€ŒÙ…Ø¯Øª', long:'Ø¨Ù„Ù†Ø¯Ù…Ø¯Øª' };

  panel.innerHTML = `<div class="cal-detail">
    <div class="cal-detail-title">
      ${dowName}ØŒ ${jd} ${J.monthNames[jm-1]} ${jy}
      ${todayBadge}
      <span style="font-size:12px;color:var(--text-muted);font-weight:400;margin-right:auto">${totalEvents} Ø±ÙˆÛŒØ¯Ø§Ø¯</span>
    </div>

    ${section('ğŸ“…','#5b9cf6','Ø¬Ù„Ø³Ø§Øª', meetings, m => `
      <div class="cal-detail-item" style="border-right:3px solid #5b9cf6">
        <div style="flex:1">
          <div style="font-weight:700">${m.title}</div>
          ${m.time||m.with ? `<div style="font-size:11px;color:var(--text-muted);margin-top:2px">${m.time?'â° '+m.time:''}${m.with?' Â· ğŸ‘¤ '+m.with:''}</div>` : ''}
          ${m.notes ? `<div style="font-size:11px;color:var(--text-muted);margin-top:3px;line-height:1.5">${m.notes}</div>` : ''}
        </div>
      </div>
    `)}

    ${section('ğŸ¯','#7c6fcd','Ø§Ù‡Ø¯Ø§Ù (Ù…Ù‡Ù„Øª)', goals, g => `
      <div class="cal-detail-item" style="border-right:3px solid #7c6fcd">
        <div style="flex:1">
          <div style="font-weight:700">${g.title}</div>
          <div style="font-size:11px;color:var(--text-muted);margin-top:2px">${hLabel[g.horizon]||''} Â· ${g.progress}% Ù¾ÛŒØ´Ø±ÙØª</div>
        </div>
        <div style="width:44px;height:4px;background:var(--border);border-radius:99px;overflow:hidden;flex-shrink:0">
          <div style="height:100%;width:${g.progress}%;background:#7c6fcd;border-radius:99px"></div>
        </div>
      </div>
    `)}

    ${section('âœ…','#e05555','Ú©Ø§Ø±Ù‡Ø§', todos, t => `
      <div class="cal-detail-item" style="border-right:3px solid ${t.priority==='high'?'#e05555':t.priority==='mid'?'#c8a96e':'#4caf7d'};${t.done?'opacity:0.45':''}">
        <div style="flex:1">
          <div style="font-weight:600;${t.done?'text-decoration:line-through':''}">${pIcon[t.priority]||''} ${t.text}</div>
          <div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:3px">
            ${t.tag ? `<span style="font-size:10px;background:var(--surface);border:1px solid var(--border);border-radius:99px;padding:1px 7px">${t.tag}</span>` : ''}
            ${t.dueTime ? `<span style="font-size:11px;color:var(--text-muted)">ğŸ• ${t.dueTime}</span>` : ''}
          </div>
        </div>
        ${t.done ? '<span style="font-size:13px;color:#4caf7d;font-weight:700">âœ“</span>' : ''}
      </div>
    `)}

    ${section('ğŸ“','#4caf7d','Ú˜ÙˆØ±Ù†Ø§Ù„', journals, j => `
      <div class="cal-detail-item" style="border-right:3px solid #4caf7d">
        <div style="flex:1;min-width:0">
          <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px">
            ${j.mood ? `<span style="font-size:20px">${j.mood}</span>` : ''}
            ${j.time ? `<span style="font-size:11px;color:var(--text-muted)">ğŸ• ${j.time}</span>` : ''}
          </div>
          <div style="font-size:13px;color:var(--text);line-height:1.6;white-space:pre-wrap">${(j.text.length > 120 ? j.text.slice(0,120)+'â€¦' : j.text).replace(/</g,'&lt;')}</div>
        </div>
      </div>
    `)}
  </div>`;
}


function renderAll() {
  renderJournal();
  renderTodos();
  renderGoals();
  renderWishes();
  renderMeetings();
  renderIdeas();
  renderCalendar();
  updateStats();
}

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
load();
initDates();
calInit();
buildWeekGrid();
renderAll();
setSyncStatus('idle');
</script>
</body>
</html>
